<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Platform workspace</title>
    <style>
      :root {
        --bg: #f5f7fb;
        --card: #ffffff;
        --text: #0f172a;
        --muted: #4b5563;
        --accent: #0055ff;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      header {
        background: #0f172a;
        color: #ffffff;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }
      header h1 {
        margin: 0;
      }
      main {
        max-width: 980px;
        margin: 2rem auto;
        padding: 0 1.5rem 2rem;
        display: grid;
        gap: 1.25rem;
      }
      .card {
        background: var(--card);
        border-radius: 14px;
        padding: 1.5rem;
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.07);
      }
      .card h3 {
        margin: 0 0 0.35rem;
      }
      .divider {
        height: 1px;
        background: #e5e7eb;
        margin: 1rem 0;
      }
      .subtle {
        color: var(--muted);
        margin: 0.25rem 0 0.75rem;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        background: rgba(0, 85, 255, 0.1);
        color: var(--accent);
        border-radius: 999px;
        padding: 0.45rem 0.7rem;
        font-weight: 700;
        letter-spacing: 0.01em;
        border: 1px solid rgba(0, 85, 255, 0.25);
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1rem;
      }
      .stat {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }
      .stat strong {
        font-size: 1.5rem;
      }
      .actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 1rem;
      }
      a.button, button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.35rem;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        border: 1px solid rgba(0, 85, 255, 0.35);
        background: var(--accent);
        color: #ffffff;
        font-weight: 700;
        cursor: pointer;
        text-decoration: none;
        transition: transform 120ms ease-in-out, box-shadow 120ms ease-in-out;
        box-shadow: 0 10px 22px rgba(0, 85, 255, 0.22);
      }
      a.button.secondary, button.secondary {
        background: #ffffff;
        color: var(--text);
        border-color: #d1d5db;
        box-shadow: none;
      }
      button:hover, a.button:hover {
        transform: translateY(-1px);
      }
      .muted {
        color: var(--muted);
        font-size: 0.95rem;
      }
      .message {
        margin-top: 0.65rem;
        padding: 0.8rem 1rem;
        border-radius: 12px;
        font-weight: 700;
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #166534;
      }
      .message.error {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.35);
        color: #7f1d1d;
      }
      form .field {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }
      form label {
        font-weight: 700;
        color: var(--text);
      }
      form input, form select, form textarea {
        padding: 0.75rem;
        border-radius: 10px;
        border: 1px solid #d1d5db;
        font-size: 1rem;
        font-family: inherit;
        transition: border-color 120ms ease-in-out, box-shadow 120ms ease-in-out;
      }
      form input:focus, form select:focus, form textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(0, 85, 255, 0.14);
      }
      textarea {
        min-height: 96px;
        resize: vertical;
      }
      .stack {
        display: grid;
        gap: 0.75rem;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.4rem 0.65rem;
        border-radius: 999px;
        background: #eef2ff;
        color: #312e81;
        font-weight: 700;
        font-size: 0.9rem;
      }
      .list {
        display: grid;
        gap: 0.6rem;
        margin: 0;
        padding: 0;
        list-style: none;
      }
      .list-item {
        padding: 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        background: #f8fafc;
      }
      .list-item strong {
        display: block;
        margin-bottom: 0.25rem;
      }
      .folder-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.75rem;
      }
      .folder-card {
        padding: 0.85rem 1rem;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: linear-gradient(180deg, #f8fafc, #eef2ff);
        display: grid;
        gap: 0.25rem;
      }
      .folder-card strong {
        font-size: 1.05rem;
      }
      .folder-meta {
        color: var(--muted);
        font-size: 0.9rem;
      }
      .dataset-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.35rem;
      }
      .dataset-table th, .dataset-table td {
        text-align: left;
        padding: 0.6rem 0.45rem;
        border-bottom: 1px solid #e5e7eb;
      }
      .dataset-table th {
        color: var(--muted);
        font-weight: 700;
      }
      .dataset-empty {
        padding: 0.8rem 1rem;
        border: 1px dashed #d1d5db;
        border-radius: 10px;
        background: #f8fafc;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <h1>Platform workspace</h1>
        <p class="subtle" id="welcome"></p>
      </div>
      <div class="actions">
        <a class="button secondary" href="./index.html">Home</a>
        <button id="sign-out" class="secondary" type="button">Sign out</button>
      </div>
    </header>
    <main>
      <div class="card">
        <div class="badge" id="role-badge">Workspace member</div>
        <h2 id="user-name" style="margin: 0.5rem 0 0;">User</h2>
        <p class="subtle" id="user-email"></p>
        <p class="muted">You are signed in to Platform. Explore runs, monitor usage, and manage your projects.</p>
        <div class="actions">
          <a class="button" href="#">Open runs</a>
          <a class="button secondary" href="#">View notifications</a>
          <a class="button secondary" id="admin-link" href="./admin-login.html" style="display: none;">Go to admin console</a>
        </div>
        <div class="message" id="session-message"></div>
      </div>

      <div class="grid">
        <div class="card stat">
          <span class="muted">Active workflows</span>
          <strong>8</strong>
          <span class="muted">Updated in the last 24 hours</span>
        </div>
        <div class="card stat">
          <span class="muted">Alerts</span>
          <strong>2</strong>
          <span class="muted">Investigate performance regressions</span>
        </div>
        <div class="card stat">
          <span class="muted">Usage</span>
          <strong>73%</strong>
          <span class="muted">Of monthly allocation</span>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="badge">Create</div>
          <h3>AIチャットベースのWebアプリを作成</h3>
          <p class="subtle">ユースケース・指示・モデルを入力すると、即座にワークスペースに追加されます。</p>
          <form id="app-builder" class="stack">
            <div class="field">
              <label for="app-name">アプリ名</label>
              <input id="app-name" name="app-name" type="text" placeholder="Customer Care Copilot" required />
            </div>
            <div class="field">
              <label for="app-purpose">ユースケース / ゴール</label>
              <textarea id="app-purpose" name="app-purpose" placeholder="FAQと注文履歴を元に、24時間のサポートチャットを提供する"></textarea>
            </div>
            <div class="field">
              <label for="app-model">ベースモデル</label>
              <select id="app-model" name="app-model">
                <option value="gpt-4o-mini">GPT-4o mini (推奨)</option>
                <option value="gpt-4o">GPT-4o</option>
                <option value="claude-3.5">Claude 3.5 Sonnet</option>
              </select>
            </div>
            <div class="field">
              <label for="app-sources">データソース</label>
              <input id="app-sources" name="app-sources" type="text" placeholder="Notion、FAQ、Postgres" />
            </div>
            <div class="actions">
              <button type="submit">Create</button>
              <button class="secondary" type="button" id="app-suggest">サンプルを読み込む</button>
            </div>
            <div class="message" id="create-message" role="status" aria-live="polite" style="display: none;"></div>
          </form>
          <div class="divider"></div>
          <div class="stack">
            <strong>最近作成したアプリ</strong>
            <div id="app-list" class="list"></div>
          </div>
        </div>

        <div class="card">
          <div class="badge">Run</div>
          <h3>AIアプリを実行・デプロイ</h3>
          <p class="subtle">作成したアプリを選んで即時にテスト実行。ラン結果は履歴に残ります。</p>
          <div class="stack">
            <div class="field">
              <label for="app-select">実行するアプリ</label>
              <select id="app-select" name="app-select"></select>
            </div>
            <div class="field">
              <label for="deploy-target">公開先</label>
              <select id="deploy-target" name="deploy-target">
                <option value="preview">プレビュー (workspace.run)</option>
                <option value="staging">Staging</option>
                <option value="production">Production</option>
              </select>
            </div>
            <div class="actions">
              <button type="button" id="run-app">Run</button>
              <button class="secondary" type="button" id="deploy-app">Deploy</button>
            </div>
            <div class="message" id="run-message" role="status" aria-live="polite" style="display: none;"></div>
          </div>
          <div class="divider"></div>
          <div class="stack">
            <strong>Run履歴</strong>
            <ul id="run-history" class="list"></ul>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="badge">Train</div>
        <h3>チャットボットの学習データベース</h3>
        <p class="subtle">作成済みボットごとに学習データをフォルダ管理で保存します。URLと紐づけて整理できます。</p>
        <div class="stack">
          <div class="field">
            <label for="dataset-bot">ボットを選択</label>
            <select id="dataset-bot" name="dataset-bot"></select>
          </div>
          <div class="grid">
            <div class="stack">
              <strong>フォルダを追加</strong>
              <form id="folder-form" class="stack">
                <div class="field">
                  <label for="folder-name">フォルダ名</label>
                  <input id="folder-name" name="folder-name" type="text" placeholder="FAQ, Product docs, Onboarding" />
                </div>
                <div class="actions">
                  <button type="submit">フォルダを追加</button>
                </div>
              </form>
            </div>
            <div class="stack">
              <strong>学習データを登録</strong>
              <form id="dataset-form" class="stack">
                <div class="field">
                  <label for="dataset-title">データ名</label>
                  <input id="dataset-title" name="dataset-title" type="text" placeholder="API v2 docs" required />
                </div>
                <div class="field">
                  <label for="dataset-source">データソース / メモ</label>
                  <textarea id="dataset-source" name="dataset-source" placeholder="Notion: API handbook、S3: api-v2.zip"></textarea>
                </div>
                <div class="field">
                  <label for="dataset-folder">保存先フォルダ</label>
                  <select id="dataset-folder" name="dataset-folder"></select>
                </div>
                <div class="actions">
                  <button type="submit">データを追加</button>
                </div>
              </form>
            </div>
          </div>
          <div class="divider"></div>
          <div class="stack">
            <strong>フォルダ一覧</strong>
            <div id="folder-list" class="folder-grid"></div>
          </div>
          <div class="divider"></div>
          <div class="stack">
            <strong>データベース</strong>
            <table class="dataset-table">
              <thead>
                <tr>
                  <th>データ名</th>
                  <th>フォルダ</th>
                  <th>メモ</th>
                  <th>登録日時</th>
                </tr>
              </thead>
              <tbody id="dataset-table-body"></tbody>
            </table>
            <div id="dataset-empty" class="dataset-empty" style="display: none;">まだデータがありません。フォルダを選んで登録してください。</div>
          </div>
          <div class="message" id="dataset-message" role="status" aria-live="polite" style="display: none;"></div>
        </div>
      </div>
    </main>
    <script>
      (() => {
        const SESSION_KEY = "platformSession";
        const REMEMBER_KEY = "platformRemember";
        const ADMIN_REMEMBER_KEY = "platformAdminRemember";
        const STORAGE_KEY = "platformAccounts";
        const APP_STORAGE_KEY = "platformAiApps";
        const RUN_STORAGE_KEY = "platformAiRuns";
        const DATASET_STORAGE_KEY = "platformBotDatasets";

        const welcomeEl = document.getElementById("welcome");
        const nameEl = document.getElementById("user-name");
        const emailEl = document.getElementById("user-email");
        const roleBadge = document.getElementById("role-badge");
        const sessionMessage = document.getElementById("session-message");
        const signOutButton = document.getElementById("sign-out");
        const adminLink = document.getElementById("admin-link");
        const appBuilderForm = document.getElementById("app-builder");
        const suggestButton = document.getElementById("app-suggest");
        const createMessage = document.getElementById("create-message");
        const appList = document.getElementById("app-list");
        const appSelect = document.getElementById("app-select");
        const runButton = document.getElementById("run-app");
        const deployButton = document.getElementById("deploy-app");
        const runMessage = document.getElementById("run-message");
        const runHistory = document.getElementById("run-history");
        const datasetBotSelect = document.getElementById("dataset-bot");
        const folderForm = document.getElementById("folder-form");
        const folderNameInput = document.getElementById("folder-name");
        const datasetForm = document.getElementById("dataset-form");
        const datasetTitleInput = document.getElementById("dataset-title");
        const datasetSourceInput = document.getElementById("dataset-source");
        const datasetFolderSelect = document.getElementById("dataset-folder");
        const folderList = document.getElementById("folder-list");
        const datasetTableBody = document.getElementById("dataset-table-body");
        const datasetEmpty = document.getElementById("dataset-empty");
        const datasetMessage = document.getElementById("dataset-message");
        let selectedDatasetAppId = null;

        function getSession() {
          const inMemory = sessionStorage.getItem(SESSION_KEY);
          if (inMemory) return JSON.parse(inMemory);
          const remembered = localStorage.getItem(REMEMBER_KEY);
          if (remembered) {
            sessionStorage.setItem(SESSION_KEY, remembered);
            return JSON.parse(remembered);
          }
          return null;
        }

        function findAccount(email) {
          try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (!stored) return null;
            const accounts = JSON.parse(stored);
            return accounts.find((acct) => acct.email.toLowerCase() === email.toLowerCase()) || null;
          } catch (error) {
            console.error("Unable to load account details", error);
            return null;
          }
        }

        function renderSession() {
          const session = getSession();
          if (!session) {
            window.location.href = "./login.html";
            return;
          }
          const account = findAccount(session.email) || session;
          const role = account.role || "Workspace member";

          welcomeEl.textContent = `Welcome back, ${account.name || session.email}.`;
          nameEl.textContent = account.name || "Workspace user";
          emailEl.textContent = account.email || session.email;
          roleBadge.textContent = role;

          const lastLogin = new Date(session.lastLogin || account.lastLogin || Date.now());
          sessionMessage.textContent = `Last activity recorded: ${lastLogin.toLocaleString()}.`;

          if (role === "Administrator") {
            adminLink.style.display = "inline-flex";
          } else {
            adminLink.style.display = "none";
          }
        }

        function loadStoredList(key, fallback = []) {
          try {
            const raw = localStorage.getItem(key);
            if (raw) return JSON.parse(raw);
          } catch (error) {
            console.error("Failed to parse storage entry", key, error);
          }
          localStorage.setItem(key, JSON.stringify(fallback));
          return [...fallback];
        }

        function loadDatasetStore() {
          try {
            const raw = localStorage.getItem(DATASET_STORAGE_KEY);
            if (raw) return JSON.parse(raw);
          } catch (error) {
            console.error("Failed to parse dataset storage", error);
          }
          localStorage.setItem(DATASET_STORAGE_KEY, JSON.stringify({}));
          return {};
        }

        function saveList(key, value) {
          localStorage.setItem(key, JSON.stringify(value));
        }

        function saveDatasetStore(value) {
          localStorage.setItem(DATASET_STORAGE_KEY, JSON.stringify(value));
        }

        function getApps() {
          const seeded = [
            {
              id: "app-support",
              name: "Customer Care Copilot",
              purpose: "FAQと注文履歴を用いて、顧客からの質問に24時間回答するチャットを提供",
              model: "GPT-4o mini",
              sources: "Notion FAQ, Order DB",
              url: "https://workspace.run/bots/customer-care-copilot",
              createdAt: new Date().toISOString()
            }
          ];
          return loadStoredList(APP_STORAGE_KEY, seeded);
        }

        function getRuns() {
          return loadStoredList(RUN_STORAGE_KEY, []);
        }

        function ensureDataset(appId) {
          const store = loadDatasetStore();
          if (!store[appId]) {
            store[appId] = {
              folders: [
                { id: "root", name: "デフォルト", createdAt: new Date().toISOString() }
              ],
              entries: []
            };
            saveDatasetStore(store);
          }
          return store[appId];
        }

        function createSlug(name) {
          return name
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, "-")
            .replace(/^-+|-+$/g, "")
            .replace(/-{2,}/g, "-") || "bot";
        }

        function createAppUrl(name) {
          const slug = createSlug(name);
          const suffix = Math.floor(Math.random() * 9000 + 1000);
          return `https://workspace.run/bots/${slug}-${suffix}`;
        }

        function renderApps() {
          const apps = getApps();
          appList.innerHTML = "";
          appSelect.innerHTML = "";
          datasetBotSelect.innerHTML = "";

          apps.forEach((app) => {
            const item = document.createElement("div");
            item.className = "list-item";
            item.innerHTML = `
              <strong>${app.name}</strong>
              <div class="muted">${app.purpose || "AIチャットアプリ"}</div>
              <div style="display: flex; gap: 0.4rem; flex-wrap: wrap; margin-top: 0.35rem;">
                <span class="pill">${app.model || "GPT-4o mini"}</span>
                <span class="pill" style="background:#ecfeff; color:#0b5ed7;">${app.sources || "データソース未指定"}</span>
              </div>
              <div class="muted" style="margin-top:0.4rem;">URL: <a href="${app.url || "#"}" target="_blank" rel="noreferrer">${app.url || "割り当て中"}</a></div>
            `;
            appList.appendChild(item);

            const option = document.createElement("option");
            option.value = app.id;
            option.textContent = app.name;
            appSelect.appendChild(option);

            const datasetOption = document.createElement("option");
            datasetOption.value = app.id;
            datasetOption.textContent = app.name;
            datasetBotSelect.appendChild(datasetOption);
          });

          if (!selectedDatasetAppId || !apps.find((app) => app.id === selectedDatasetAppId)) {
            selectedDatasetAppId = apps[0]?.id ?? null;
          }
          if (datasetBotSelect && selectedDatasetAppId) {
            datasetBotSelect.value = selectedDatasetAppId;
          }
          renderDatasetSection();
        }

        function renderRuns() {
          const runs = getRuns();
          runHistory.innerHTML = "";
          if (!runs.length) {
            const empty = document.createElement("li");
            empty.className = "list-item";
            empty.textContent = "まだRunはありません。作成したアプリを実行してください。";
            runHistory.appendChild(empty);
            return;
          }
          runs.slice(-5).reverse().forEach((run) => {
            const item = document.createElement("li");
            item.className = "list-item";
            item.innerHTML = `
              <strong>${run.appName}</strong>
              <div class="muted">結果: ${run.result} ・ 環境: ${run.target}</div>
              <div class="muted">${new Date(run.timestamp).toLocaleString()}</div>
            `;
            runHistory.appendChild(item);
          });
        }

        function showMessage(target, text, type = "success") {
          if (!target) return;
          target.style.display = "block";
          target.textContent = text;
          target.className = `message ${type}`;
        }

        function renderFolders(dataset) {
          folderList.innerHTML = "";
          datasetFolderSelect.innerHTML = "";

          dataset.folders.forEach((folder) => {
            const entryCount = dataset.entries.filter((entry) => entry.folderId === folder.id).length;
            const card = document.createElement("div");
            card.className = "folder-card";
            card.innerHTML = `
              <strong>${folder.name}</strong>
              <div class="folder-meta">データ数: ${entryCount}</div>
              <div class="folder-meta">作成日: ${new Date(folder.createdAt).toLocaleString()}</div>
            `;
            folderList.appendChild(card);

            const option = document.createElement("option");
            option.value = folder.id;
            option.textContent = `${folder.name} (${entryCount})`;
            datasetFolderSelect.appendChild(option);
          });
        }

        function renderDatasetTable(dataset) {
          datasetTableBody.innerHTML = "";
          if (!dataset.entries.length) {
            datasetEmpty.style.display = "block";
            return;
          }
          datasetEmpty.style.display = "none";
          dataset.entries
            .slice()
            .sort((a, b) => new Date(b.addedAt) - new Date(a.addedAt))
            .forEach((entry) => {
              const row = document.createElement("tr");
              const folder = dataset.folders.find((item) => item.id === entry.folderId);
              row.innerHTML = `
                <td>${entry.title}</td>
                <td>${folder ? folder.name : "デフォルト"}</td>
                <td>${entry.source || "記載なし"}</td>
                <td>${new Date(entry.addedAt).toLocaleString()}</td>
              `;
              datasetTableBody.appendChild(row);
            });
        }

        function renderDatasetSection() {
          if (!selectedDatasetAppId) {
            folderList.innerHTML = "";
            datasetTableBody.innerHTML = "";
            datasetFolderSelect.innerHTML = "";
            datasetEmpty.style.display = "block";
            return;
          }
          const dataset = ensureDataset(selectedDatasetAppId);
          renderFolders(dataset);
          renderDatasetTable(dataset);
        }

        appBuilderForm?.addEventListener("submit", (event) => {
          event.preventDefault();
          const name = document.getElementById("app-name").value.trim();
          const purpose = document.getElementById("app-purpose").value.trim();
          const model = document.getElementById("app-model").value;
          const sources = document.getElementById("app-sources").value.trim();

          if (!name) {
            showMessage(createMessage, "アプリ名を入力してください。", "error");
            return;
          }

          const apps = getApps();
          const exists = apps.some((app) => app.name.toLowerCase() === name.toLowerCase());
          if (exists) {
            showMessage(createMessage, "同名のアプリが既に存在します。別の名前を指定してください。", "error");
            return;
          }

          const newApp = {
            id: crypto.randomUUID ? crypto.randomUUID() : `app-${Date.now()}`,
            name,
            purpose,
            model: model === "gpt-4o-mini" ? "GPT-4o mini" : model,
            sources: sources || "データソース未指定",
            url: createAppUrl(name),
            createdAt: new Date().toISOString()
          };

          selectedDatasetAppId = newApp.id;
          apps.push(newApp);
          saveList(APP_STORAGE_KEY, apps);
          appBuilderForm.reset();
          showMessage(createMessage, `AIチャットベースのWebアプリを作成しました。URL: ${newApp.url}`, "success");
          renderApps();
        });

        suggestButton?.addEventListener("click", () => {
          document.getElementById("app-name").value = "Docs Q&A Copilot";
          document.getElementById("app-purpose").value = "社内ナレッジベースとGitHub READMEを検索して回答するチャットUIを生成";
          document.getElementById("app-model").value = "gpt-4o-mini";
          document.getElementById("app-sources").value = "Notion, GitHub repo, Slack export";
          showMessage(createMessage, "サンプルを読み込みました。このままCreateを押してください。", "success");
        });

        function handleRun(target) {
          const apps = getApps();
          const selectedId = appSelect.value || (apps[0]?.id ?? null);
          const selectedApp = apps.find((app) => app.id === selectedId);
          if (!selectedApp) {
            showMessage(runMessage, "先にアプリを作成してください。", "error");
            return;
          }

          showMessage(runMessage, `${selectedApp.name} を${target === "Deploy" ? "デプロイ" : "実行"}しています…`, "success");
          runButton?.setAttribute("disabled", "true");
          deployButton?.setAttribute("disabled", "true");

          setTimeout(() => {
            const runs = getRuns();
            const entry = {
              appName: selectedApp.name,
              target: document.getElementById("deploy-target").value,
              timestamp: new Date().toISOString(),
              result: target === "Deploy" ? "デプロイ完了 (プレビューURLを発行しました)" : "成功"
            };
            runs.push(entry);
            saveList(RUN_STORAGE_KEY, runs);
            renderRuns();
            showMessage(runMessage, target === "Deploy" ? "デプロイが完了しました。プレビューURLを共有できます。" : "Runが完了しました。チャットUIが応答可能です。", "success");
            runButton?.removeAttribute("disabled");
            deployButton?.removeAttribute("disabled");
          }, 850);
        }

        runButton?.addEventListener("click", () => handleRun("Run"));
        deployButton?.addEventListener("click", () => handleRun("Deploy"));

        datasetBotSelect?.addEventListener("change", (event) => {
          selectedDatasetAppId = event.target.value;
          renderDatasetSection();
        });

        folderForm?.addEventListener("submit", (event) => {
          event.preventDefault();
          if (!selectedDatasetAppId) return;
          const name = folderNameInput.value.trim();
          if (!name) {
            showMessage(datasetMessage, "フォルダ名を入力してください。", "error");
            return;
          }
          const store = loadDatasetStore();
          const dataset = ensureDataset(selectedDatasetAppId);
          const duplicate = dataset.folders.find((folder) => folder.name.toLowerCase() === name.toLowerCase());
          if (duplicate) {
            showMessage(datasetMessage, "同名のフォルダが既に存在します。別の名前にしてください。", "error");
            return;
          }
          dataset.folders.push({ id: `folder-${Date.now()}`, name, createdAt: new Date().toISOString() });
          store[selectedDatasetAppId] = dataset;
          saveDatasetStore(store);
          folderNameInput.value = "";
          showMessage(datasetMessage, "フォルダを追加しました。", "success");
          renderDatasetSection();
        });

        datasetForm?.addEventListener("submit", (event) => {
          event.preventDefault();
          if (!selectedDatasetAppId) return;
          const title = datasetTitleInput.value.trim();
          const source = datasetSourceInput.value.trim();
          const folderId = datasetFolderSelect.value || "root";
          if (!title) {
            showMessage(datasetMessage, "データ名を入力してください。", "error");
            return;
          }
          const store = loadDatasetStore();
          const dataset = ensureDataset(selectedDatasetAppId);
          dataset.entries.push({
            id: `entry-${Date.now()}`,
            title,
            source,
            folderId,
            addedAt: new Date().toISOString()
          });
          store[selectedDatasetAppId] = dataset;
          saveDatasetStore(store);
          datasetTitleInput.value = "";
          datasetSourceInput.value = "";
          showMessage(datasetMessage, "学習データを保存しました。", "success");
          renderDatasetSection();
        });

        signOutButton?.addEventListener("click", () => {
          sessionStorage.removeItem(SESSION_KEY);
          sessionStorage.removeItem("platformAdminSession");
          localStorage.removeItem(REMEMBER_KEY);
          localStorage.removeItem(ADMIN_REMEMBER_KEY);
          window.location.href = "./login.html";
        });

        renderApps();
        renderRuns();
        renderSession();
      })();
    </script>
  </body>
</html>
