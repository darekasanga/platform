<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Platform workspace</title>
    <style>
      :root {
        --bg: #f5f7fb;
        --card: #ffffff;
        --text: #0f172a;
        --muted: #4b5563;
        --accent: #0055ff;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      header {
        background: #0f172a;
        color: #ffffff;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }
      header h1 {
        margin: 0;
      }
      main {
        max-width: 980px;
        margin: 2rem auto;
        padding: 0 1.5rem 2rem;
        display: grid;
        gap: 1.25rem;
      }
      .card {
        background: var(--card);
        border-radius: 14px;
        padding: 1.5rem;
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.07);
      }
      .card h3 {
        margin: 0 0 0.35rem;
      }
      .divider {
        height: 1px;
        background: #e5e7eb;
        margin: 1rem 0;
      }
      .subtle {
        color: var(--muted);
        margin: 0.25rem 0 0.75rem;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        background: rgba(0, 85, 255, 0.1);
        color: var(--accent);
        border-radius: 999px;
        padding: 0.45rem 0.7rem;
        font-weight: 700;
        letter-spacing: 0.01em;
        border: 1px solid rgba(0, 85, 255, 0.25);
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1rem;
      }
      .stat {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }
      .stat strong {
        font-size: 1.5rem;
      }
      .actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 1rem;
      }
      a.button, button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.35rem;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        border: 1px solid rgba(0, 85, 255, 0.35);
        background: var(--accent);
        color: #ffffff;
        font-weight: 700;
        cursor: pointer;
        text-decoration: none;
        transition: transform 120ms ease-in-out, box-shadow 120ms ease-in-out;
        box-shadow: 0 10px 22px rgba(0, 85, 255, 0.22);
      }
      a.button.secondary, button.secondary {
        background: #ffffff;
        color: var(--text);
        border-color: #d1d5db;
        box-shadow: none;
      }
      button:hover, a.button:hover {
        transform: translateY(-1px);
      }
      .muted {
        color: var(--muted);
        font-size: 0.95rem;
      }
      .message {
        margin-top: 0.65rem;
        padding: 0.8rem 1rem;
        border-radius: 12px;
        font-weight: 700;
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #166534;
      }
      .message.error {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.35);
        color: #7f1d1d;
      }
      form .field {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }
      form label {
        font-weight: 700;
        color: var(--text);
      }
      form input, form select, form textarea {
        padding: 0.75rem;
        border-radius: 10px;
        border: 1px solid #d1d5db;
        font-size: 1rem;
        font-family: inherit;
        transition: border-color 120ms ease-in-out, box-shadow 120ms ease-in-out;
      }
      form input:focus, form select:focus, form textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(0, 85, 255, 0.14);
      }
      textarea {
        min-height: 96px;
        resize: vertical;
      }
      .stack {
        display: grid;
        gap: 0.75rem;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.4rem 0.65rem;
        border-radius: 999px;
        background: #eef2ff;
        color: #312e81;
        font-weight: 700;
        font-size: 0.9rem;
      }
      .list {
        display: grid;
        gap: 0.6rem;
        margin: 0;
        padding: 0;
        list-style: none;
      }
      .list-item {
        padding: 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        background: #f8fafc;
      }
      .list-item strong {
        display: block;
        margin-bottom: 0.25rem;
      }
      .folder-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.75rem;
      }
      .folder-card {
        padding: 0.85rem 1rem;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: linear-gradient(180deg, #f8fafc, #eef2ff);
        display: grid;
        gap: 0.25rem;
      }
      .folder-card strong {
        font-size: 1.05rem;
      }
      .folder-meta {
        color: var(--muted);
        font-size: 0.9rem;
      }
      .dataset-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.35rem;
      }
      .dataset-table th, .dataset-table td {
        text-align: left;
        padding: 0.6rem 0.45rem;
        border-bottom: 1px solid #e5e7eb;
      }
      .dataset-table th {
        color: var(--muted);
        font-weight: 700;
      }
      .dataset-empty {
        padding: 0.8rem 1rem;
        border: 1px dashed #d1d5db;
        border-radius: 10px;
        background: #f8fafc;
        color: var(--muted);
      }
      .pill.neutral {
        background: #f3f4f6;
        color: #111827;
        border: 1px solid #e5e7eb;
      }
      .code-area {
        width: 100%;
        min-height: 120px;
        background: #0f172a;
        color: #e2e8f0;
        border-radius: 10px;
        border: 1px solid #1f2937;
        padding: 0.75rem;
        font-family: "SFMono-Regular", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New",
          monospace;
        resize: vertical;
      }
      .embed-preview {
        position: relative;
        min-height: 240px;
        border: 1px dashed #d1d5db;
        border-radius: 12px;
        padding: 1rem;
        background: linear-gradient(180deg, #ffffff, #f8fafc);
        overflow: hidden;
      }
      .embed-floating {
        position: absolute;
        right: 0.75rem;
        bottom: 0.75rem;
        display: grid;
        gap: 0.5rem;
        align-items: flex-end;
        justify-items: end;
      }
      .embed-bubble {
        width: 100%;
        max-width: 420px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 15px 36px rgba(0, 0, 0, 0.12);
        background: #ffffff;
        padding: 0.75rem;
      }
      .code-actions {
        display: flex;
        gap: 0.6rem;
        flex-wrap: wrap;
        align-items: center;
      }
      .tab-shell {
        display: grid;
        gap: 1rem;
      }
      .tablist {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .tablist button {
        border-radius: 999px;
        border: 1px solid #d1d5db;
        background: #ffffff;
        color: var(--text);
        padding: 0.65rem 1.1rem;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 10px 18px rgba(15, 23, 42, 0.08);
        transition: all 120ms ease-in-out;
      }
      .tablist button.active {
        background: var(--accent);
        color: #ffffff;
        border-color: rgba(0, 85, 255, 0.35);
        box-shadow: 0 12px 28px rgba(0, 85, 255, 0.22);
      }
      .tab-panel {
        display: none;
      }
      .tab-panel.active {
        display: block;
      }
      .prominent-select {
        border: 2px solid rgba(0, 85, 255, 0.35);
        box-shadow: 0 10px 22px rgba(0, 85, 255, 0.1);
        background: linear-gradient(180deg, #ffffff, #f7f9ff);
        font-weight: 700;
      }
      .app-select-callout {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.45rem 0.75rem;
        border-radius: 999px;
        background: rgba(0, 85, 255, 0.08);
        color: var(--accent);
        font-weight: 700;
        border: 1px solid rgba(0, 85, 255, 0.2);
      }
      .theme-preview {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        padding: 0.4rem 0.65rem;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #f8fafc;
      }
      .theme-dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 1px solid #d1d5db;
        flex-shrink: 0;
      }
      .dataset-detail-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1rem;
        background: linear-gradient(180deg, #ffffff, #f8fafc);
        display: grid;
        gap: 0.75rem;
      }
      .dataset-detail-body {
        display: grid;
        gap: 0.65rem;
      }
      .dataset-file-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 0.35rem;
      }
      .ghost-button {
        background: transparent;
        border: 1px dashed #d1d5db;
        color: var(--muted);
        border-radius: 10px;
        padding: 0.35rem 0.65rem;
        cursor: pointer;
        transition: border-color 120ms ease-in-out, color 120ms ease-in-out;
      }
      .ghost-button:hover {
        border-color: #ef4444;
        color: #b91c1c;
      }
      .detail-note {
        background: #ecfeff;
        color: #0b5ed7;
        padding: 0.55rem 0.65rem;
        border-radius: 10px;
        border: 1px solid rgba(14, 165, 233, 0.25);
      }
      .image-preview {
        display: grid;
        gap: 0.65rem;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 0.85rem;
        background: linear-gradient(180deg, #ffffff, #f8fafc);
      }
      .preview-toolbar {
        display: flex;
        justify-content: space-between;
        gap: 0.75rem;
        align-items: center;
        flex-wrap: wrap;
      }
      .preview-controls {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        flex-wrap: wrap;
      }
      .preview-controls label {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-weight: 700;
        color: var(--text);
      }
      .preview-controls input[type="range"] {
        accent-color: var(--accent);
      }
      .preview-meta {
        color: var(--muted);
        font-weight: 700;
      }
      .image-preview-frame {
        position: relative;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 0.75rem;
        min-height: 220px;
        display: grid;
        place-items: center;
        overflow: hidden;
      }
      .image-preview-frame img {
        max-width: 100%;
        max-height: 320px;
        border-radius: 10px;
        transition: transform 120ms ease-in-out;
        box-shadow: 0 14px 32px rgba(15, 23, 42, 0.18);
      }
      .preview-theme {
        position: absolute;
        right: 12px;
        bottom: 12px;
        padding: 0.4rem 0.7rem;
        border-radius: 999px;
        border: 1px solid #d1d5db;
        background: rgba(255, 255, 255, 0.8);
        font-weight: 700;
        backdrop-filter: blur(4px);
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.08);
      }
      .text-mono {
        font-family: "SFMono-Regular", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.95rem;
      }
      .selected-bot-card {
        border: 1px solid #dbeafe;
        background: linear-gradient(180deg, #f8fbff, #eef2ff);
        border-radius: 14px;
        padding: 1rem 1.25rem;
        box-shadow: 0 14px 30px rgba(59, 130, 246, 0.12);
        display: grid;
        gap: 0.75rem;
      }
      .selected-bot-layout {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 0.85rem;
        align-items: start;
      }
      .selected-bot-name {
        margin: 0.2rem 0 0;
        font-size: 1.3rem;
      }
      .selected-bot-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        align-items: center;
        margin-top: 0.45rem;
      }
      .url-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 0.5rem;
        align-items: center;
        border: 1px dashed #bfdbfe;
        background: #f8fafc;
        border-radius: 10px;
        padding: 0.55rem 0.65rem;
      }
      .url-actions {
        display: flex;
        gap: 0.4rem;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .link-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.6rem;
        border-radius: 999px;
        background: #eef2ff;
        color: #1e3a8a;
        text-decoration: none;
        font-weight: 700;
      }
      .theme-update {
        display: grid;
        gap: 0.45rem;
      }
      .theme-update-controls {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        align-items: center;
      }
      .learning-summary {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 0.6rem;
      }
      .learning-summary .list-item {
        background: linear-gradient(180deg, #ffffff, #f3f4f6);
        border-color: #e5e7eb;
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <h1>Platform workspace</h1>
        <p class="subtle" id="welcome"></p>
      </div>
      <div class="actions">
        <a class="button secondary" href="./index.html">Home</a>
        <button id="sign-out" class="secondary" type="button">Sign out</button>
      </div>
    </header>
    <main>
      <div class="card">
        <div class="badge" id="role-badge">Workspace member</div>
        <h2 id="user-name" style="margin: 0.5rem 0 0;">User</h2>
        <p class="subtle" id="user-email"></p>
        <p class="muted">You are signed in to Platform. Explore runs, monitor usage, and manage your projects.</p>
        <div class="actions">
          <a class="button" href="#">Open runs</a>
          <a class="button secondary" href="#">View notifications</a>
          <a class="button secondary" id="admin-link" href="./admin-login.html" style="display: none;">Go to admin console</a>
        </div>
        <div class="message" id="session-message"></div>
      </div>

      <div class="grid">
        <div class="card stat">
          <span class="muted">Active workflows</span>
          <strong>8</strong>
          <span class="muted">Updated in the last 24 hours</span>
        </div>
        <div class="card stat">
          <span class="muted">Alerts</span>
          <strong>2</strong>
          <span class="muted">Investigate performance regressions</span>
        </div>
        <div class="card stat">
          <span class="muted">Usage</span>
          <strong>73%</strong>
          <span class="muted">Of monthly allocation</span>
        </div>
      </div>

      <div class="tab-shell" aria-label="Workspace sections">
        <div class="tablist" role="tablist">
          <button class="active" role="tab" aria-selected="true" aria-controls="tab-create" data-tab="create">Create</button>
          <button role="tab" aria-selected="false" aria-controls="tab-run" data-tab="run">Run</button>
          <button role="tab" aria-selected="false" aria-controls="tab-share" data-tab="share">Share</button>
          <button role="tab" aria-selected="false" aria-controls="tab-train" data-tab="train">Train</button>
        </div>
        <div class="tab-panels">
          <div class="tab-panel active" id="tab-create" data-tab="create" role="tabpanel">
            <div class="card">
              <div class="badge">Create</div>
              <h3>AIチャットベースのWebアプリを作成</h3>
              <p class="subtle">ユースケース・指示・モデルを入力すると、即座にワークスペースに追加されます。</p>
              <form id="app-builder" class="stack">
                <div class="field">
                  <label for="app-name">アプリ名</label>
                  <input id="app-name" name="app-name" type="text" placeholder="Customer Care Copilot" required />
                </div>
                <div class="field">
                  <label for="app-purpose">ユースケース / ゴール</label>
                  <textarea id="app-purpose" name="app-purpose" placeholder="FAQと注文履歴を元に、24時間のサポートチャットを提供する"></textarea>
                </div>
                <div class="field">
                  <label for="app-model">ベースモデル</label>
                  <select id="app-model" name="app-model">
                    <option value="gpt-4o-mini">GPT-4o mini (推奨)</option>
                    <option value="gpt-4o">GPT-4o</option>
                    <option value="claude-3.5">Claude 3.5 Sonnet</option>
                  </select>
                </div>
                <div class="field">
                  <label for="app-theme">チャットウィンドウのテーマ (全10種)</label>
                  <select id="app-theme" name="app-theme" class="prominent-select">
                    <option value="ocean">Ocean breeze</option>
                    <option value="forest">Forest walk</option>
                    <option value="midnight">Midnight neon</option>
                    <option value="sunrise">Sunrise glow</option>
                    <option value="lavender">Lavender field</option>
                    <option value="solar">Solar flare</option>
                    <option value="minimal">Minimal white</option>
                    <option value="coral">Coral sand</option>
                    <option value="slate">Slate focus</option>
                    <option value="emerald">Emerald tone</option>
                  </select>
                  <p class="subtle" style="margin: 0;">テーマは埋め込みコードにも反映され、チャットウィンドウの配色やアクセントが切り替わります。</p>
                </div>
                <div class="field">
                  <label for="app-sources">データソース</label>
                  <input id="app-sources" name="app-sources" type="text" placeholder="Notion、FAQ、Postgres" />
                </div>
                <div class="field">
                  <label for="fallback-message">登録外の質問への回答</label>
                  <textarea id="fallback-message" name="fallback-message" placeholder="登録されていない質問やデータは安全な定型文で回答します。" aria-describedby="fallback-note"></textarea>
                  <p id="fallback-note" class="subtle" style="margin: 0;">例: 「申し訳ありませんが、登録情報にない内容なので一般的なご案内のみお伝えします。」</p>
                </div>
                <div class="actions">
                  <button type="submit">Create</button>
                  <button class="secondary" type="button" id="app-suggest">サンプルを読み込む</button>
                </div>
                <div class="message" id="create-message" role="status" aria-live="polite" style="display: none;"></div>
              </form>
              <div class="divider"></div>
              <div class="stack">
                <strong>最近作成したアプリ</strong>
                <div id="app-list" class="list"></div>
              </div>
            </div>
          </div>
          <div class="tab-panel" id="tab-run" data-tab="run" role="tabpanel">
            <div class="card">
              <div class="badge">Run</div>
              <h3>AIアプリを実行・デプロイ</h3>
              <p class="subtle">作成したアプリを選んで即時にテスト実行。ラン結果は履歴に残ります。</p>
              <div class="stack">
                <div class="field">
                  <label for="app-select">実行するアプリ <span class="app-select-callout">ここでチャットボットを選択</span></label>
                  <select id="app-select" name="app-select" class="prominent-select"></select>
                </div>
                <div class="field">
                  <label for="deploy-target">公開先</label>
                  <select id="deploy-target" name="deploy-target">
                    <option value="preview">プレビュー (ログイン不要)</option>
                    <option value="staging">Staging</option>
                    <option value="production">Production</option>
                  </select>
                </div>
                <div class="actions">
                  <button type="button" id="run-app">Run</button>
                  <button class="secondary" type="button" id="deploy-app">Deploy</button>
                </div>
                <div class="message" id="run-message" role="status" aria-live="polite" style="display: none;"></div>
              </div>
              <div class="divider"></div>
              <div class="stack">
                <strong>Run履歴</strong>
                <ul id="run-history" class="list"></ul>
              </div>
            </div>
          </div>
          <div class="tab-panel" id="tab-share" data-tab="share" role="tabpanel">
            <div class="card">
              <div class="badge">Share</div>
              <h3>ボットの共有と埋め込み</h3>
              <p class="subtle">ホームページ右下のポップアップ、別ウィンドウ表示、TRAINページリンクをワンクリックで発行できます。</p>
              <div id="selected-bot-card" class="selected-bot-card" aria-live="polite">
                <div class="selected-bot-layout">
                  <div>
                    <div class="selected-bot-tags">
                      <span class="pill neutral" style="margin:0;">選択中のチャットボット</span>
                      <span class="pill" id="selected-bot-theme-label" style="margin:0;"></span>
                    </div>
                    <h4 class="selected-bot-name" id="selected-bot-name">-</h4>
                    <p class="subtle" id="selected-bot-purpose" style="margin:0.15rem 0 0.45rem;">ボットを選択すると概要が表示されます。</p>
                    <div class="selected-bot-tags">
                      <span class="pill" id="selected-bot-model" style="margin:0;">-</span>
                      <span class="theme-preview" id="selected-bot-theme-preview">
                        <span class="theme-dot" style="background:#0ea5e9;"></span>
                        <span id="selected-bot-theme-text">Theme</span>
                      </span>
                    </div>
                  </div>
                  <div class="stack">
                    <div class="url-row">
                      <div>
                        <strong>プレビューURL</strong>
                        <div class="muted text-mono" id="selected-preview-url" style="margin-top:0.25rem;">-</div>
                      </div>
                      <div class="url-actions">
                        <button type="button" class="secondary" id="open-preview-url">開く</button>
                        <button type="button" class="secondary" id="copy-preview-url">コピー</button>
                      </div>
                    </div>
                    <div class="url-row">
                      <div>
                        <strong>TRAINページURL</strong>
                        <div class="muted text-mono" id="selected-train-url" style="margin-top:0.25rem;">-</div>
                      </div>
                      <div class="url-actions">
                        <button type="button" class="secondary" id="open-train-url">開く</button>
                        <button type="button" class="secondary" id="copy-train-url">コピー</button>
                      </div>
                    </div>
                    <div class="theme-update">
                      <label for="selected-theme">テーマを後から変更</label>
                      <div class="theme-update-controls">
                        <select id="selected-theme" name="selected-theme"></select>
                        <button type="button" id="save-selected-theme">テーマを保存</button>
                      </div>
                      <p class="subtle" style="margin:0;">埋め込みコードとプレビューに即時反映されます。</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="grid">
                <div class="stack">
                  <div class="field">
                    <label for="share-bot">共有するボット <span class="app-select-callout">埋め込み対象を選択</span></label>
                    <select id="share-bot" name="share-bot" class="prominent-select"></select>
                  </div>
                  <div class="field">
                    <label>ポップアップサイズ</label>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                      <label style="display: flex; align-items: center; gap: 0.25rem;"><input type="radio" name="bot-size" value="small" /> Small (320×420)</label>
                      <label style="display: flex; align-items: center; gap: 0.25rem;"><input type="radio" name="bot-size" value="medium" checked /> Medium (360×520)</label>
                      <label style="display: flex; align-items: center; gap: 0.25rem;"><input type="radio" name="bot-size" value="large" /> Large (420×640)</label>
                    </div>
                  </div>
                  <div class="code-actions">
                    <button type="button" id="copy-embed">埋め込みコードをコピー</button>
                    <button type="button" class="secondary" id="bot-window-button">別ウィンドウでボットを開く</button>
                    <button type="button" class="secondary" id="copy-train-share">TRAINコードをコピー</button>
                    <button type="button" class="secondary" id="open-train-window">TRAINページを開く</button>
                  </div>
                  <p class="muted" id="bot-url-display" style="margin: 0.25rem 0 0.65rem;"></p>
                  <div id="fallback-preview" class="message" style="display:none; background: rgba(59,130,246,0.08); color: #1d4ed8; border-color: rgba(59,130,246,0.32);">
                    登録外の質問には「申し訳ありませんが、登録情報にない内容なので一般的なご案内のみお伝えします。」と案内します。
                  </div>
                  <label for="embed-code" style="font-weight: 700; color: var(--text);">HTMLに貼り付けるコード</label>
                  <textarea id="embed-code" class="code-area" readonly aria-label="ボット埋め込みコード"></textarea>
                  <div class="divider"></div>
                  <label for="train-embed-share" style="font-weight: 700; color: var(--text);">TRAINページを新規ウィンドウで開くコード</label>
                  <textarea id="train-embed-share" class="code-area" readonly aria-label="TRAINページ埋め込みコード"></textarea>
                  <div id="share-message" class="message" style="display: none;"></div>
                </div>
                <div class="embed-preview">
                  <div id="bot-preview-label" class="muted" style="margin-bottom: 0.5rem;">プレビュー</div>
                  <div id="bot-popup-preview" class="embed-floating"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-panel" id="tab-train" data-tab="train" role="tabpanel">
            <div class="card">
              <div class="badge">Train</div>
              <h3>チャットボットの学習データベース</h3>
              <p class="subtle">作成済みボットごとに学習データをフォルダ管理で保存します。URLと紐づけて整理できます。</p>
              <div class="stack">
                <div class="field">
                  <label for="dataset-bot">ボットを選択 <span class="app-select-callout">学習先チャットボットを指定</span></label>
                  <select id="dataset-bot" name="dataset-bot" class="prominent-select"></select>
                </div>
                <div class="grid">
                  <div class="stack">
                    <strong>フォルダを追加</strong>
                    <form id="folder-form" class="stack">
                      <div class="field">
                        <label for="folder-name">フォルダ名</label>
                        <input id="folder-name" name="folder-name" type="text" placeholder="FAQ, Product docs, Onboarding" />
                      </div>
                      <div class="actions">
                        <button type="submit">フォルダを追加</button>
                      </div>
                    </form>
                  </div>
                  <div class="stack">
                    <strong>学習データを登録</strong>
                    <form id="dataset-form" class="stack">
                      <div class="field">
                        <label for="dataset-title">データ名</label>
                        <input id="dataset-title" name="dataset-title" type="text" placeholder="API v2 docs" required />
                      </div>
                      <div class="field">
                        <label for="dataset-source">データソース / メモ</label>
                        <textarea id="dataset-source" name="dataset-source" placeholder="Notion: API handbook、S3: api-v2.zip"></textarea>
                      </div>
                      <div class="field">
                        <label for="dataset-learning">学習内容の要約・ポイント</label>
                        <textarea id="dataset-learning" name="dataset-learning" placeholder="画像から抽出したテキスト、ファイルから得た箇条書きなどを記載"></textarea>
                        <p class="subtle" style="margin:0;">画像・PDF・CSVなどファイル別に「何を学習したか」を残すと、後で詳細を確認できます。</p>
                      </div>
                      <div class="field">
                        <label for="dataset-filetype">ファイルタイプ</label>
                        <select id="dataset-filetype" name="dataset-filetype">
                          <option value="pdf">PDF</option>
                          <option value="doc">Word / DOC</option>
                          <option value="excel">Excel / CSV</option>
                          <option value="image">画像 (PNG/JPEG/GIF)</option>
                          <option value="zip">ZIP (まとめてアップロード)</option>
                          <option value="other">その他</option>
                        </select>
                      </div>
                      <div class="field">
                        <label for="dataset-files">ファイルを添付</label>
                        <input id="dataset-files" name="dataset-files" type="file" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.png,.jpg,.jpeg,.gif,.zip" />
                        <p class="subtle" style="margin: 0;">PDF / DOC / EXCEL / 画像 / ZIP をまとめてドラッグ＆ドロップできます。</p>
                      </div>
                      <div class="field">
                        <label for="dataset-folder">保存先フォルダ</label>
                        <select id="dataset-folder" name="dataset-folder"></select>
                      </div>
                      <div class="actions">
                        <button type="submit">データを追加</button>
                      </div>
                    </form>
                  </div>
                </div>
                <div class="divider"></div>
                <div class="stack">
                  <strong>フォルダ一覧</strong>
                  <div id="folder-list" class="folder-grid"></div>
                </div>
                <div class="divider"></div>
                <div class="stack">
                  <strong>データベース</strong>
                  <table class="dataset-table">
                    <thead>
                      <tr>
                        <th>データ名</th>
                        <th>ファイル</th>
                        <th>フォルダ</th>
                        <th>メモ</th>
                        <th>登録日時</th>
                        <th>詳細</th>
                      </tr>
                    </thead>
                    <tbody id="dataset-table-body"></tbody>
                  </table>
                  <div id="dataset-empty" class="dataset-empty" style="display: none;">まだデータがありません。フォルダを選んで登録してください。</div>
                  <div class="dataset-detail-card" id="dataset-detail-card" aria-live="polite">
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:0.75rem; flex-wrap:wrap;">
                      <div>
                        <div class="muted" style="margin-bottom:0.15rem;">学習内容の詳細</div>
                        <strong id="dataset-detail-title">まだデータが選択されていません</strong>
                      </div>
                      <span class="pill neutral" id="dataset-detail-filetype" style="margin:0;">-</span>
                    </div>
                  <div class="dataset-detail-body">
                    <div class="detail-note" id="dataset-detail-learning">画像やPDFなどの学習ポイントがここに表示されます。</div>
                    <div class="image-preview" id="image-preview" style="display:none;">
                      <div class="preview-toolbar">
                        <div class="preview-controls">
                          <label for="preview-zoom">拡大率</label>
                          <input id="preview-zoom" type="range" min="50" max="200" value="100" />
                          <label for="preview-background">背景色</label>
                          <input id="preview-background" type="color" value="#0b1224" />
                        </div>
                        <div class="preview-meta" id="preview-meta">プレビューを読み込み中…</div>
                      </div>
                      <div class="image-preview-frame" id="image-preview-frame">
                        <img id="preview-image" alt="画像プレビュー" />
                        <div class="preview-theme" id="preview-theme">全体表示テーマ</div>
                      </div>
                    </div>
                    <div>
                      <div class="muted" style="margin-bottom:0.25rem;">ファイル/画像の内訳</div>
                      <ul class="dataset-file-list" id="dataset-detail-files"></ul>
                    </div>
                  </div>
                  </div>
                </div>
                <div class="stack">
                  <strong>ファイルからの学習内容一覧</strong>
                  <p class="subtle" style="margin:0 0 0.5rem;">読み込み可能なファイルに紐づく学習ノートをまとめて表示します。</p>
                  <ul id="learning-summary" class="learning-summary"></ul>
                </div>
                <div class="divider"></div>
                <div class="stack">
                  <strong>TRAINページリンク</strong>
                  <p class="subtle">ボットごとのTRAINページを新規ウィンドウや外部サイトから開けます。</p>
                  <div class="code-actions">
                    <button type="button" id="copy-train-embed" class="secondary">TRAIN埋め込みコードをコピー</button>
                  </div>
                  <textarea id="train-embed-code" class="code-area" readonly aria-label="TRAINページの埋め込みコード"></textarea>
                </div>
                <div class="message" id="dataset-message" role="status" aria-live="polite" style="display: none;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <script>
      (() => {
        const SESSION_KEY = "platformSession";
        const REMEMBER_KEY = "platformRemember";
        const ADMIN_REMEMBER_KEY = "platformAdminRemember";
        const STORAGE_KEY = "platformAccounts";
        const APP_STORAGE_KEY = "platformAiApps";
        const RUN_STORAGE_KEY = "platformAiRuns";
        const DATASET_STORAGE_KEY = "platformBotDatasets";
        const PREVIEW_ORIGIN = window.location.origin;
        const BOT_PREVIEW_PATH = "/bot-preview.html";
        const TRAIN_PREVIEW_PATH = "/train-preview.html";
        const DEFAULT_FALLBACK_MESSAGE = "申し訳ありませんが、登録されていない内容なので一般的なご案内のみお伝えします。";

        const THEME_LIBRARY = {
          ocean: { label: "Ocean breeze", accent: "#0ea5e9", frame: "#0b1224", text: "#0f172a", buttonText: "#ffffff" },
          forest: { label: "Forest walk", accent: "#16a34a", frame: "#064e3b", text: "#062b1b", buttonText: "#ffffff" },
          midnight: { label: "Midnight neon", accent: "#6366f1", frame: "#0b1224", text: "#e2e8f0", buttonText: "#ffffff" },
          sunrise: { label: "Sunrise glow", accent: "#f97316", frame: "#2f0a00", text: "#0f172a", buttonText: "#0f172a" },
          lavender: { label: "Lavender field", accent: "#8b5cf6", frame: "#2e1065", text: "#1e1b4b", buttonText: "#ffffff" },
          solar: { label: "Solar flare", accent: "#f59e0b", frame: "#1f2937", text: "#0f172a", buttonText: "#0f172a" },
          minimal: { label: "Minimal white", accent: "#111827", frame: "#f8fafc", text: "#0f172a", buttonText: "#ffffff" },
          coral: { label: "Coral sand", accent: "#fb7185", frame: "#3f0e1b", text: "#0f172a", buttonText: "#ffffff" },
          slate: { label: "Slate focus", accent: "#334155", frame: "#0f172a", text: "#0f172a", buttonText: "#ffffff" },
          emerald: { label: "Emerald tone", accent: "#10b981", frame: "#064e3b", text: "#0f172a", buttonText: "#0f172a" }
        };

        const welcomeEl = document.getElementById("welcome");
        const nameEl = document.getElementById("user-name");
        const emailEl = document.getElementById("user-email");
        const roleBadge = document.getElementById("role-badge");
        const sessionMessage = document.getElementById("session-message");
        const signOutButton = document.getElementById("sign-out");
        const adminLink = document.getElementById("admin-link");
        const appBuilderForm = document.getElementById("app-builder");
        const suggestButton = document.getElementById("app-suggest");
        const createMessage = document.getElementById("create-message");
        const appList = document.getElementById("app-list");
        const appSelect = document.getElementById("app-select");
        const appThemeSelect = document.getElementById("app-theme");
        const fallbackInput = document.getElementById("fallback-message");
        const runButton = document.getElementById("run-app");
        const deployButton = document.getElementById("deploy-app");
        const runMessage = document.getElementById("run-message");
        const runHistory = document.getElementById("run-history");
        const shareBotSelect = document.getElementById("share-bot");
        const embedCodeOutput = document.getElementById("embed-code");
        const trainEmbedShareOutput = document.getElementById("train-embed-share");
        const shareMessage = document.getElementById("share-message");
        const embedSizeRadios = document.querySelectorAll('input[name="bot-size"]');
        const botPopupPreview = document.getElementById("bot-popup-preview");
        const botPreviewLabel = document.getElementById("bot-preview-label");
        const openBotWindowButton = document.getElementById("bot-window-button");
        const botUrlDisplay = document.getElementById("bot-url-display");
        const copyEmbedButton = document.getElementById("copy-embed");
        const copyTrainShareButton = document.getElementById("copy-train-share");
        const openTrainWindowButton = document.getElementById("open-train-window");
        const datasetBotSelect = document.getElementById("dataset-bot");
        const folderForm = document.getElementById("folder-form");
        const folderNameInput = document.getElementById("folder-name");
        const datasetForm = document.getElementById("dataset-form");
        const datasetTitleInput = document.getElementById("dataset-title");
        const datasetSourceInput = document.getElementById("dataset-source");
        const datasetFileTypeSelect = document.getElementById("dataset-filetype");
        const datasetFilesInput = document.getElementById("dataset-files");
        const datasetFolderSelect = document.getElementById("dataset-folder");
        const datasetLearningInput = document.getElementById("dataset-learning");
        const folderList = document.getElementById("folder-list");
        const datasetTableBody = document.getElementById("dataset-table-body");
        const datasetEmpty = document.getElementById("dataset-empty");
        const datasetMessage = document.getElementById("dataset-message");
        const copyTrainEmbedButton = document.getElementById("copy-train-embed");
        const trainEmbedDatasetOutput = document.getElementById("train-embed-code");
        const datasetDetailTitle = document.getElementById("dataset-detail-title");
        const datasetDetailFileType = document.getElementById("dataset-detail-filetype");
        const datasetDetailLearning = document.getElementById("dataset-detail-learning");
        const datasetDetailFiles = document.getElementById("dataset-detail-files");
        const fallbackPreview = document.getElementById("fallback-preview");
        const selectedBotCard = document.getElementById("selected-bot-card");
        const selectedBotName = document.getElementById("selected-bot-name");
        const selectedBotPurpose = document.getElementById("selected-bot-purpose");
        const selectedBotModel = document.getElementById("selected-bot-model");
        const selectedBotThemeLabel = document.getElementById("selected-bot-theme-label");
        const selectedBotThemePreview = document.getElementById("selected-bot-theme-preview");
        const selectedBotThemeText = document.getElementById("selected-bot-theme-text");
        const selectedPreviewUrl = document.getElementById("selected-preview-url");
        const selectedTrainUrl = document.getElementById("selected-train-url");
        const copyPreviewUrlButton = document.getElementById("copy-preview-url");
        const openPreviewUrlButton = document.getElementById("open-preview-url");
        const copyTrainUrlButton = document.getElementById("copy-train-url");
        const openTrainUrlButton = document.getElementById("open-train-url");
        const selectedThemeSelect = document.getElementById("selected-theme");
        const saveSelectedThemeButton = document.getElementById("save-selected-theme");
        const learningSummaryList = document.getElementById("learning-summary");
        const tabButtons = Array.from(document.querySelectorAll(".tablist button"));
        const tabPanels = Array.from(document.querySelectorAll(".tab-panel"));
        let selectedDatasetAppId = null;
        let selectedShareAppId = null;
        let selectedDatasetEntryId = null;
        let currentPreviewLabel = "画像プレビュー";

        function activateTab(target) {
          const tabId = target || "create";
          tabButtons.forEach((button) => {
            const isActive = button.dataset.tab === tabId;
            button.classList.toggle("active", isActive);
            button.setAttribute("aria-selected", isActive ? "true" : "false");
            button.setAttribute("tabindex", isActive ? "0" : "-1");
          });
          tabPanels.forEach((panel) => {
            const isActive = panel.dataset.tab === tabId;
            panel.classList.toggle("active", isActive);
            panel.hidden = !isActive;
          });
        }

        function getTheme(key) {
          return THEME_LIBRARY[key] || THEME_LIBRARY.ocean;
        }

        function populateThemeSelect(selectElement, selectedValue) {
          if (!selectElement) return;
          selectElement.innerHTML = "";
          Object.entries(THEME_LIBRARY).forEach(([key, meta]) => {
            const option = document.createElement("option");
            option.value = key;
            option.textContent = meta.label;
            if (selectedValue && selectedValue === key) option.selected = true;
            selectElement.appendChild(option);
          });
          if (selectedValue && THEME_LIBRARY[selectedValue]) {
            selectElement.value = selectedValue;
          }
        }

        function escapeForEmbed(value) {
          return (value || "")
            .replace(/\\/g, "\\\\")
            .replace(/`/g, "\\`")
            .replace(/'/g, "\\'")
            .replace(/\r?\n/g, " ");
        }

        function ensureThemeOptions() {
          if (appThemeSelect) {
            populateThemeSelect(appThemeSelect, appThemeSelect.value || "ocean");
          }
          if (selectedThemeSelect && !selectedThemeSelect.options.length) {
            populateThemeSelect(selectedThemeSelect, selectedThemeSelect.value || "ocean");
          }
        }

        function getSession() {
          const inMemory = sessionStorage.getItem(SESSION_KEY);
          if (inMemory) return JSON.parse(inMemory);
          const remembered = localStorage.getItem(REMEMBER_KEY);
          if (remembered) {
            sessionStorage.setItem(SESSION_KEY, remembered);
            return JSON.parse(remembered);
          }
          return null;
        }

        function findAccount(email) {
          try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (!stored) return null;
            const accounts = JSON.parse(stored);
            return accounts.find((acct) => acct.email.toLowerCase() === email.toLowerCase()) || null;
          } catch (error) {
            console.error("Unable to load account details", error);
            return null;
          }
        }

        function renderSession() {
          const session = getSession();
          if (!session) {
            window.location.href = "./login.html";
            return;
          }
          const account = findAccount(session.email) || session;
          const role = account.role || "Workspace member";

          welcomeEl.textContent = `Welcome back, ${account.name || session.email}.`;
          nameEl.textContent = account.name || "Workspace user";
          emailEl.textContent = account.email || session.email;
          roleBadge.textContent = role;

          const lastLogin = new Date(session.lastLogin || account.lastLogin || Date.now());
          sessionMessage.textContent = `Last activity recorded: ${lastLogin.toLocaleString()}.`;

          if (role === "Administrator") {
            adminLink.style.display = "inline-flex";
          } else {
            adminLink.style.display = "none";
          }
        }

        function loadStoredList(key, fallback = []) {
          try {
            const raw = localStorage.getItem(key);
            if (raw) return JSON.parse(raw);
          } catch (error) {
            console.error("Failed to parse storage entry", key, error);
          }
          localStorage.setItem(key, JSON.stringify(fallback));
          return [...fallback];
        }

        function loadDatasetStore() {
          try {
            const raw = localStorage.getItem(DATASET_STORAGE_KEY);
            if (raw) return JSON.parse(raw);
          } catch (error) {
            console.error("Failed to parse dataset storage", error);
          }
          localStorage.setItem(DATASET_STORAGE_KEY, JSON.stringify({}));
          return {};
        }

        function saveList(key, value) {
          localStorage.setItem(key, JSON.stringify(value));
        }

        function saveDatasetStore(value) {
          localStorage.setItem(DATASET_STORAGE_KEY, JSON.stringify(value));
        }

        function getApps() {
          const seeded = [
            {
              id: "app-support",
              name: "Customer Care Copilot",
              purpose: "FAQと注文履歴を用いて、顧客からの質問に24時間回答するチャットを提供",
              model: "GPT-4o mini",
              sources: "Notion FAQ, Order DB",
              theme: "ocean",
              fallbackMessage: DEFAULT_FALLBACK_MESSAGE,
              url: `${PREVIEW_ORIGIN}${BOT_PREVIEW_PATH}?bot=customer-care-copilot`,
              createdAt: new Date().toISOString()
            }
          ];
          const apps = loadStoredList(APP_STORAGE_KEY, seeded);
          let mutated = false;
          const enhanced = apps.map((app) => {
            const enriched = { ...app };
            if (!enriched.theme || !THEME_LIBRARY[enriched.theme]) {
              enriched.theme = "ocean";
              mutated = true;
            }
            if (!enriched.fallbackMessage) {
              enriched.fallbackMessage = DEFAULT_FALLBACK_MESSAGE;
              mutated = true;
            }
            if (!enriched.url || enriched.url.includes("workspace.run")) {
              enriched.url = createAppUrl(enriched.name);
              mutated = true;
            }
            if (!enriched.trainUrl || enriched.trainUrl.includes("workspace.run")) {
              enriched.trainUrl = createTrainUrl(enriched.name);
              mutated = true;
            }
            return enriched;
          });
          if (mutated) {
            saveList(APP_STORAGE_KEY, enhanced);
          }
          return enhanced;
        }

        function getRuns() {
          return loadStoredList(RUN_STORAGE_KEY, []);
        }

        function ensureDataset(appId) {
          const store = loadDatasetStore();
          if (!store[appId]) {
            store[appId] = {
              folders: [
                { id: "root", name: "デフォルト", createdAt: new Date().toISOString() }
              ],
              entries: []
            };
            saveDatasetStore(store);
          }
          const dataset = store[appId];
          if (!dataset.seeded && appId === "app-support" && (!dataset.entries || !dataset.entries.length)) {
            dataset.entries.push(
              {
                id: "entry-faq",
                title: "FAQメインデータ",
                source: "Notion FAQ · 2024Q4更新版",
                folderId: "root",
                fileType: "pdf",
                files: [{ name: "faq-master.pdf", size: 482000, type: "application/pdf" }],
                learningNotes: "よくある質問と回答例を段落ごとに分割し、重要語句を抽出してベクトル化。登録外の質問には一般的なサポート手順を案内するように設定。",
                addedAt: new Date().toISOString()
              },
              {
                id: "entry-hero",
                title: "製品画像からの学習",
                source: "ブランドイメージ / ヒーロー画像",
                folderId: "root",
                fileType: "image",
                files: [
                  { name: "hero-shot.png", size: 192000, type: "image/png" },
                  { name: "packaging.jpg", size: 142000, type: "image/jpeg" }
                ],
                learningNotes: "画像に含まれるキャッチコピー、カラーパレット、ロゴ位置を抽出し、回答にブランドトーンを反映。図や文字がない部分は説明文を生成して補完。",
                addedAt: new Date().toISOString()
              }
            );
            dataset.seeded = true;
            store[appId] = dataset;
            saveDatasetStore(store);
          }
          return dataset;
        }

        function createSlug(name) {
          return name
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, "-")
            .replace(/^-+|-+$/g, "")
            .replace(/-{2,}/g, "-") || "bot";
        }

        function createAppUrl(name) {
          const slug = createSlug(name);
          const suffix = Math.floor(Math.random() * 9000 + 1000);
          return `${PREVIEW_ORIGIN}${BOT_PREVIEW_PATH}?bot=${slug}-${suffix}`;
        }

        function createTrainUrl(name) {
          const slug = createSlug(name);
          return `${PREVIEW_ORIGIN}${TRAIN_PREVIEW_PATH}?bot=${slug}`;
        }

        function renderApps() {
          const apps = getApps();
          appList.innerHTML = "";
          appSelect.innerHTML = "";
          datasetBotSelect.innerHTML = "";
          shareBotSelect.innerHTML = "";

          if (!apps.length) {
            appList.innerHTML = '<div class="dataset-empty">まだチャットボットがありません。Createタブから作成してください。</div>';
            selectedDatasetAppId = null;
            selectedShareAppId = null;
            renderDatasetSection();
            if (embedCodeOutput) embedCodeOutput.value = "";
            if (trainEmbedShareOutput) trainEmbedShareOutput.value = "";
            if (fallbackPreview) fallbackPreview.style.display = "none";
            if (selectedBotCard) selectedBotCard.style.display = "none";
            return;
          }

          apps.forEach((app) => {
            const theme = getTheme(app.theme);
            const item = document.createElement("div");
            item.className = "list-item";
            item.innerHTML = `
              <div style="display:flex; justify-content:space-between; gap:0.5rem; align-items:center; flex-wrap:wrap;">
                <strong>${app.name}</strong>
                <button type="button" class="ghost-button" data-delete="${app.id}">削除</button>
              </div>
              <div class="muted">${app.purpose || "AIチャットアプリ"}</div>
              <div style="display: flex; gap: 0.4rem; flex-wrap: wrap; margin-top: 0.35rem;">
                <span class="pill">${app.model || "GPT-4o mini"}</span>
                <span class="pill" style="background:#ecfeff; color:#0b5ed7;">${app.sources || "データソース未指定"}</span>
                <span class="theme-preview"><span class="theme-dot" style="background:${theme.accent};"></span>${theme.label}</span>
              </div>
              <div class="muted text-mono" style="margin-top:0.35rem;">登録外: ${app.fallbackMessage || DEFAULT_FALLBACK_MESSAGE}</div>
              <div class="muted" style="margin-top:0.4rem;">URL: <a href="${app.url || "#"}" target="_blank" rel="noreferrer">${app.url || "割り当て中"}</a></div>
            `;
            appList.appendChild(item);

            const option = document.createElement("option");
            option.value = app.id;
            option.textContent = app.name;
            appSelect.appendChild(option);

            const datasetOption = document.createElement("option");
            datasetOption.value = app.id;
            datasetOption.textContent = app.name;
            datasetBotSelect.appendChild(datasetOption);

            const shareOption = document.createElement("option");
            shareOption.value = app.id;
            shareOption.textContent = app.name;
            shareBotSelect.appendChild(shareOption);

            const deleteButton = item.querySelector('button[data-delete]');
            deleteButton?.addEventListener("click", () => handleDeleteApp(app.id));
          });

          if (!selectedDatasetAppId || !apps.find((app) => app.id === selectedDatasetAppId)) {
            selectedDatasetAppId = apps[0]?.id ?? null;
          }
          if (!selectedShareAppId || !apps.find((app) => app.id === selectedShareAppId)) {
            selectedShareAppId = apps[0]?.id ?? null;
          }
          if (datasetBotSelect && selectedDatasetAppId) {
            datasetBotSelect.value = selectedDatasetAppId;
          }
          if (shareBotSelect && selectedShareAppId) {
            shareBotSelect.value = selectedShareAppId;
          }
          renderDatasetSection();
          renderShareSection();
        }

        function handleDeleteApp(appId) {
          const apps = getApps();
          const target = apps.find((app) => app.id === appId);
          if (!target) return;
          const confirmed = window.confirm(`${target.name} を削除しますか？関連する学習データ・履歴も整理されます。`);
          if (!confirmed) return;
          const updatedApps = apps.filter((app) => app.id !== appId);
          saveList(APP_STORAGE_KEY, updatedApps);
          const store = loadDatasetStore();
          if (store[appId]) {
            delete store[appId];
            saveDatasetStore(store);
          }
          const filteredRuns = getRuns().filter((run) => run.appId !== appId && run.appName !== target.name);
          saveList(RUN_STORAGE_KEY, filteredRuns);
          if (selectedDatasetAppId === appId) {
            selectedDatasetAppId = updatedApps[0]?.id ?? null;
            selectedDatasetEntryId = null;
          }
          if (selectedShareAppId === appId) {
            selectedShareAppId = updatedApps[0]?.id ?? null;
          }
          showMessage(createMessage, `${target.name} を削除しました。`, "success");
          renderApps();
          renderRuns();
        }

        function renderRuns() {
          const runs = getRuns();
          runHistory.innerHTML = "";
          if (!runs.length) {
            const empty = document.createElement("li");
            empty.className = "list-item";
            empty.textContent = "まだRunはありません。作成したアプリを実行してください。";
            runHistory.appendChild(empty);
            return;
          }
          runs.slice(-5).reverse().forEach((run) => {
            const item = document.createElement("li");
            item.className = "list-item";
            item.innerHTML = `
              <strong>${run.appName}</strong>
              <div class="muted">結果: ${run.result} ・ 環境: ${run.target}</div>
              <div class="muted">${new Date(run.timestamp).toLocaleString()}</div>
            `;
            runHistory.appendChild(item);
          });
        }

        function getAppById(appId) {
          return getApps().find((app) => app.id === appId) || null;
        }

        function getPopupSize(size) {
          const sizes = {
            small: { width: 320, height: 420 },
            medium: { width: 360, height: 520 },
            large: { width: 420, height: 640 }
          };
          return sizes[size] || sizes.medium;
        }

        function buildEmbedCode(app, size) {
          const { width, height } = getPopupSize(size);
          const theme = getTheme(app.theme);
          const safeReply = escapeForEmbed(app.fallbackMessage || DEFAULT_FALLBACK_MESSAGE);
          return [
            '<div id="workspace-bot-launcher"></div>',
            '<script>',
            "(function(){",
            "  var botUrl = '" + app.url + "';",
            "  var theme = { accent: '" + theme.accent + "', frame: '" + theme.frame + "', text: '" + theme.text + "', buttonText: '" + theme.buttonText + "' };",
            "  var safeReply = '" + safeReply + "';",
            "  var launcher = document.getElementById('workspace-bot-launcher');",
            "  if (!launcher) { launcher = document.createElement('div'); document.body.appendChild(launcher); }",
            "  launcher.style.position = 'fixed';",
            "  launcher.style.right = '18px';",
            "  launcher.style.bottom = '18px';",
            "  launcher.style.zIndex = '9999';",
            "  launcher.style.display = 'grid';",
            "  launcher.style.gap = '8px';",
            "  var toggle = document.createElement('button');",
            "  toggle.textContent = 'Chat with " + escapeForEmbed(app.name) + "';",
            "  toggle.style.padding = '12px 14px';",
            "  toggle.style.borderRadius = '999px';",
            "  toggle.style.background = theme.accent;",
            "  toggle.style.color = theme.buttonText;",
            "  toggle.style.border = '1px solid rgba(0,0,0,0.05)';",
            "  toggle.style.boxShadow = '0 12px 28px rgba(0, 0, 0, 0.2)';",
            "  toggle.style.cursor = 'pointer';",
            "  var frame = document.createElement('iframe');",
            "  frame.src = botUrl;",
            "  frame.title = '" + escapeForEmbed(app.name) + " chat';",
            "  frame.style.width = '" + width + "px';",
            "  frame.style.height = '" + height + "px';",
            "  frame.style.border = '1px solid rgba(0,0,0,0.08)';",
            "  frame.style.borderRadius = '12px';",
            "  frame.style.boxShadow = '0 15px 36px rgba(0,0,0,0.14)';",
            "  frame.style.background = theme.frame;",
            "  frame.style.display = 'none';",
            "  toggle.addEventListener('click', function(){",
            "    var open = frame.style.display !== 'none';",
            "    frame.style.display = open ? 'none' : 'block';",
            "  });",
            "  var fallback = document.createElement('div');",
            "  fallback.textContent = '登録外の質問には: ' + safeReply;",
            "  fallback.style.fontSize = '12px';",
            "  fallback.style.color = theme.text;",
            "  fallback.style.background = 'rgba(255,255,255,0.8)';",
            "  fallback.style.border = '1px solid rgba(0,0,0,0.05)';",
            "  fallback.style.padding = '6px 10px';",
            "  fallback.style.borderRadius = '10px';",
            "  launcher.appendChild(frame);",
            "  launcher.appendChild(toggle);",
            "  launcher.appendChild(fallback);",
            "})();",
            "<\/script>"
          ].join("\n");
        }

        function buildTrainEmbedCode(app) {
          return [
            '<button id=\"train-launch\" style=\"padding:12px 14px;border-radius:10px;border:1px solid #d1d5db;background:#fff;font-weight:700;cursor:pointer;\">',
            `${app.name} のTRAINページを開く`,
            "</button>",
            "<script>",
            "(function(){",
            "  var button = document.getElementById('train-launch');",
            "  if (!button) return;",
            "  button.addEventListener('click', function(e){",
            "    e.preventDefault();",
            "    window.open('" + app.trainUrl + "', '_blank', 'width=1200,height=780');",
            "  });",
            "})();",
            "<\/script>"
          ].join("\n");
        }

        function updateAppTheme(appId, themeKey) {
          if (!THEME_LIBRARY[themeKey]) return null;
          const apps = getApps();
          const index = apps.findIndex((app) => app.id === appId);
          if (index === -1) return null;
          const updated = { ...apps[index], theme: themeKey };
          apps[index] = updated;
          saveList(APP_STORAGE_KEY, apps);
          return updated;
        }

        function describeFileType(type) {
          const map = {
            pdf: "PDF",
            doc: "Word / DOC",
            excel: "Excel / CSV",
            image: "画像",
            zip: "ZIP",
            other: "その他"
          };
          return map[type] || "テキスト / その他";
        }

        function generateLearningNotes(entry) {
          if (entry.learningNotes && entry.learningNotes.trim()) return entry.learningNotes.trim();
          if (entry.fileType === "image") return "画像に含まれる文字や色、ロゴ位置を抽出し、ブランドトーンを回答に反映。";
          if (entry.fileType === "pdf") return "PDFの段落ごとに要約とキーワードを抽出し、回答の根拠として保存。";
          if (entry.fileType === "excel") return "表データのヘッダーを特徴語に変換し、行単位で検索しやすいベクトルを生成。";
          if (entry.fileType === "doc") return "段落・見出しを解析し、重要文をまとめて回答に利用。";
          return "ファイルを分割して埋め込み化し、登録外の質問には安全な定型文で応答。";
        }

        function describeAttachment(file, fallbackType) {
          const type = file?.type || fallbackType;
          if (type?.startsWith("image/")) return `${file.name} · 画像から色/文字要素を抽出`;
          if (type?.includes("pdf")) return `${file.name} · PDFをセクション分割`;
          if (type?.includes("csv") || type?.includes("excel") || fallbackType === "excel") return `${file.name} · テーブル構造を学習`;
          if (type?.includes("word") || fallbackType === "doc") return `${file.name} · 見出し/本文を要約`;
          return `${file?.name || "ファイル"} · 主要トピックを抽出`;
        }

        function createPlaceholderPreview(label, accent = "#0ea5e9") {
          const text = (label || "Preview").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
          const color = accent;
          return `data:image/svg+xml;charset=utf-8,` +
            encodeURIComponent(
              `<svg xmlns='http://www.w3.org/2000/svg' width='640' height='360' viewBox='0 0 640 360'>` +
                `<defs><linearGradient id='grad' x1='0%' y1='0%' x2='100%' y2='100%'>` +
                `<stop offset='0%' stop-color='${color}' stop-opacity='0.18'/>` +
                `<stop offset='100%' stop-color='${color}' stop-opacity='0.08'/></linearGradient></defs>` +
                `<rect width='640' height='360' rx='18' fill='url(#grad)'/>` +
                `<text x='50%' y='52%' dominant-baseline='middle' text-anchor='middle' fill='#0f172a' font-family='Inter, system-ui' font-size='22' font-weight='700'>${text}</text>` +
              `</svg>`
            );
        }

        function getAccessibleTextColor(hex) {
          if (!hex) return "#0f172a";
          const normalized = hex.replace("#", "");
          const expanded = normalized.length === 3
            ? normalized.split("").map((c) => c + c).join("")
            : normalized.padEnd(6, "f");
          const bigint = parseInt(expanded.slice(0, 6), 16);
          const r = (bigint >> 16) & 255;
          const g = (bigint >> 8) & 255;
          const b = bigint & 255;
          const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
          return luminance > 0.6 ? "#0f172a" : "#f8fafc";
        }

        function readImagePreview(file) {
          return new Promise((resolve) => {
            if (!file || !(file.type || "").startsWith("image/")) return resolve(null);
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => resolve(null);
            reader.readAsDataURL(file);
          });
        }

        function applyPreviewBackground(color) {
          if (!previewFrame || !previewMeta || !previewTheme) return;
          previewFrame.style.background = color;
          const textColor = getAccessibleTextColor(color);
          previewMeta.style.color = textColor;
          previewTheme.style.color = textColor;
          previewTheme.style.borderColor = `${textColor}55`;
          previewTheme.style.background = textColor === "#f8fafc" ? "rgba(15, 23, 42, 0.08)" : "rgba(255,255,255,0.12)";
        }

        function applyPreviewZoom(value) {
          if (!previewImage || !previewMeta) return;
          const zoom = Number(value) || 100;
          previewImage.style.transform = `scale(${zoom / 100})`;
          previewMeta.textContent = `${currentPreviewLabel} · ${zoom}%`;
        }

        function renderImagePreview(entry, app) {
          if (!imagePreview) return;
          const theme = getTheme(app?.theme);
          const files = Array.isArray(entry?.files) ? entry.files : [];
          const imageFile = files.find((file) => (file.type || "").startsWith("image/"));
          if (!entry || (entry.fileType !== "image" && !imageFile)) {
            imagePreview.style.display = "none";
            return;
          }
          imagePreview.style.display = "grid";
          currentPreviewLabel = imageFile?.name || entry.title || "画像プレビュー";
          const src = entry.previewDataUrl || imageFile?.previewDataUrl || createPlaceholderPreview(currentPreviewLabel, theme.accent);
          if (previewImage) {
            previewImage.src = src;
            previewImage.alt = currentPreviewLabel;
          }
          if (previewTheme) {
            previewTheme.textContent = `全体表示テーマ: ${theme.label}`;
          }
          const initialBackground = previewBackgroundInput?.value || theme.frame || "#0b1224";
          if (previewBackgroundInput) previewBackgroundInput.value = initialBackground;
          applyPreviewBackground(initialBackground);
          const defaultZoom = previewZoomInput?.value || "100";
          applyPreviewZoom(defaultZoom);
        }

        function renderDatasetDetails(entry, dataset) {
          if (!datasetDetailTitle || !datasetDetailLearning || !datasetDetailFiles || !datasetDetailFileType) return;
          if (!entry) {
            datasetDetailTitle.textContent = "まだデータが選択されていません";
            datasetDetailLearning.textContent = "画像やPDFなどの学習ポイントがここに表示されます。";
            datasetDetailFiles.innerHTML = "";
            datasetDetailFileType.textContent = "-";
            if (imagePreview) imagePreview.style.display = "none";
            return;
          }
          const folder = dataset?.folders?.find((item) => item.id === entry.folderId);
          const files = Array.isArray(entry.files) ? entry.files : [];
          datasetDetailTitle.textContent = `${entry.title}（${folder ? folder.name : "デフォルト"}）`;
          datasetDetailFileType.textContent = describeFileType(entry.fileType);
          datasetDetailLearning.textContent = generateLearningNotes(entry);
          const parentApp = getAppById(selectedDatasetAppId);
          renderImagePreview(entry, parentApp);
          datasetDetailFiles.innerHTML = "";
          if (!files.length) {
            const li = document.createElement("li");
            li.className = "muted";
            li.textContent = "添付なし: URLやメモのみで学習しています。";
            datasetDetailFiles.appendChild(li);
          } else {
            files.forEach((file) => {
              const li = document.createElement("li");
              li.innerHTML = `<div class="list-item" style="padding:0.65rem; display:flex; justify-content:space-between; align-items:center; gap:0.5rem;">
                <div>
                  <strong>${file.name}</strong>
                  <div class="muted">${describeAttachment(file, entry.fileType)}</div>
                </div>
                <span class="pill neutral" style="margin:0;">${describeFileType(entry.fileType)}</span>
              </div>`;
              datasetDetailFiles.appendChild(li);
            });
          }
        }

        function renderLearningSummary(dataset) {
          if (!learningSummaryList) return;
          learningSummaryList.innerHTML = "";
          if (!dataset || !dataset.entries || !dataset.entries.length) {
            const item = document.createElement("li");
            item.className = "list-item muted";
            item.textContent = "まだ学習データがありません。ファイルを追加すると学習内容の一覧が表示されます。";
            learningSummaryList.appendChild(item);
            return;
          }
          const fileEntries = dataset.entries.filter((entry) => Array.isArray(entry.files) && entry.files.length);
          if (!fileEntries.length) {
            const item = document.createElement("li");
            item.className = "list-item muted";
            item.textContent = "ファイルを含むデータはまだありません。アップロードすると、読み込み可能な内容がここに表示されます。";
            learningSummaryList.appendChild(item);
            return;
          }
          fileEntries
            .slice()
            .sort((a, b) => new Date(b.addedAt) - new Date(a.addedAt))
            .forEach((entry) => {
              const folder = dataset.folders.find((item) => item.id === entry.folderId);
              const li = document.createElement("li");
              li.className = "list-item";
              li.innerHTML = `
                <div style="display:flex; justify-content:space-between; gap:0.75rem; align-items:center; flex-wrap:wrap;">
                  <div>
                    <strong>${entry.title}</strong>
                    <div class="muted">${folder ? folder.name : "デフォルト"} · ${entry.files.length}件のファイルを読み込み済み</div>
                    <div class="muted" style="margin-top:0.25rem;">${generateLearningNotes(entry)}</div>
                  </div>
                  <span class="pill neutral" style="margin:0;">${describeFileType(entry.fileType)}</span>
                </div>
              `;
              learningSummaryList.appendChild(li);
            });
        }

        function renderShareSection() {
          const apps = getApps();
          if (!apps.length || !shareBotSelect) return;
          const size = Array.from(embedSizeRadios || []).find((input) => input.checked)?.value || "medium";
          const selectedId = shareBotSelect.value || selectedShareAppId || apps[0].id;
          const app = apps.find((item) => item.id === selectedId) || apps[0];
          selectedShareAppId = app?.id ?? null;

          if (shareBotSelect && selectedShareAppId) {
            shareBotSelect.value = selectedShareAppId;
          }

          const theme = getTheme(app?.theme);
          populateThemeSelect(selectedThemeSelect, app?.theme || "ocean");

          if (selectedBotCard) {
            selectedBotCard.style.display = app ? "grid" : "none";
          }
          if (selectedBotName) selectedBotName.textContent = app?.name || "-";
          if (selectedBotPurpose) selectedBotPurpose.textContent = app?.purpose || "用途メモがあるとプレビューに表示されます。";
          if (selectedBotModel) selectedBotModel.textContent = app?.model || "GPT-4o mini";
          if (selectedBotThemeLabel) selectedBotThemeLabel.textContent = `テーマ: ${theme.label}`;
          if (selectedBotThemeText) selectedBotThemeText.textContent = theme.label;
          if (selectedBotThemePreview) {
            const dot = selectedBotThemePreview.querySelector(".theme-dot");
            if (dot) dot.style.background = theme.accent;
          }
          if (selectedPreviewUrl) {
            selectedPreviewUrl.textContent = app?.url || "-";
            selectedPreviewUrl.dataset.href = app?.url || "";
          }
          if (selectedTrainUrl) {
            selectedTrainUrl.textContent = app?.trainUrl || "-";
            selectedTrainUrl.dataset.href = app?.trainUrl || "";
          }

          if (embedCodeOutput && app) {
            embedCodeOutput.value = buildEmbedCode(app, size);
          }
          if (trainEmbedShareOutput && app) {
            trainEmbedShareOutput.value = buildTrainEmbedCode(app);
          }
          if (botUrlDisplay && app) {
            botUrlDisplay.textContent = `Bot URL: ${app.url}｜TRAIN: ${app.trainUrl}`;
          }
          if (botPreviewLabel && app) {
            botPreviewLabel.textContent = `${app.name} のプレビュー (${size}, テーマ: ${theme.label})`;
          }
          if (fallbackPreview && app) {
            fallbackPreview.style.display = "block";
            fallbackPreview.textContent = `登録外の質問には: ${app.fallbackMessage || DEFAULT_FALLBACK_MESSAGE}`;
          }
          if (botPopupPreview && app) {
            const { width, height } = getPopupSize(size);
            botPopupPreview.innerHTML = "";
            const bubble = document.createElement("div");
            bubble.className = "embed-bubble";
            bubble.style.borderColor = `${theme.accent}33`;
            bubble.style.background = `linear-gradient(180deg, #ffffff, ${theme.accent}11)`;
            bubble.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
                <strong style="color:#0f172a;">${app.name}</strong>
                <span class="pill neutral" style="margin:0;">${width} × ${height}</span>
              </div>
              <div class="muted" style="margin-bottom:0.5rem;">右下のバッジから開くポップアップを想定したプレビューです。テーマ「${theme.label}」で表示します。</div>
              <div style="height: ${Math.min(height, 260)}px; border:1px solid ${theme.accent}44; border-radius:10px; background:${theme.frame}; color:#e2e8f0; display:grid; place-items:center;">${app.url}</div>
            `;
            const button = document.createElement("button");
            button.className = "button";
            button.type = "button";
            button.textContent = "ホームページで開くイメージ";
            button.style.justifySelf = "end";
            button.style.background = theme.accent;
            button.style.color = theme.buttonText;
            botPopupPreview.appendChild(bubble);
            botPopupPreview.appendChild(button);
          }
        }

        function showMessage(target, text, type = "success") {
          if (!target) return;
          target.style.display = "block";
          target.textContent = text;
          target.className = `message ${type}`;
        }

        function copyToClipboard(value, target, successText, errorText) {
          if (!value) return;
          navigator.clipboard
            ?.writeText(value)
            .then(() => showMessage(target, successText, "success"))
            .catch(() => showMessage(target, errorText, "error"));
        }

        function renderFolders(dataset) {
          folderList.innerHTML = "";
          datasetFolderSelect.innerHTML = "";

          dataset.folders.forEach((folder) => {
            const entryCount = dataset.entries.filter((entry) => entry.folderId === folder.id).length;
            const card = document.createElement("div");
            card.className = "folder-card";
            card.innerHTML = `
              <strong>${folder.name}</strong>
              <div class="folder-meta">データ数: ${entryCount}</div>
              <div class="folder-meta">作成日: ${new Date(folder.createdAt).toLocaleString()}</div>
            `;
            folderList.appendChild(card);

            const option = document.createElement("option");
            option.value = folder.id;
            option.textContent = `${folder.name} (${entryCount})`;
            datasetFolderSelect.appendChild(option);
          });
        }

        function renderDatasetTable(dataset) {
          datasetTableBody.innerHTML = "";
          if (!dataset.entries.length) {
            datasetEmpty.style.display = "block";
            selectedDatasetEntryId = null;
            renderDatasetDetails(null, dataset);
            return;
          }
          datasetEmpty.style.display = "none";
          dataset.entries
            .slice()
            .sort((a, b) => new Date(b.addedAt) - new Date(a.addedAt))
            .forEach((entry) => {
              if (!selectedDatasetEntryId) {
                selectedDatasetEntryId = entry.id;
              }
              const row = document.createElement("tr");
              const folder = dataset.folders.find((item) => item.id === entry.folderId);
              const files = Array.isArray(entry.files) ? entry.files : [];
              const previewNames = files.slice(0, 2).map((file) => file.name).join(", ");
              const fileSummary = files.length
                ? `${files.length}ファイル (${previewNames || describeFileType(entry.fileType)})`
                : "メモ / リンクで学習";
              row.innerHTML = `
                <td>${entry.title}</td>
                <td>
                  <div class="pill neutral">${describeFileType(entry.fileType)}</div>
                  <div class="muted">${fileSummary}</div>
                </td>
                <td>${folder ? folder.name : "デフォルト"}</td>
                <td>${entry.source || "記載なし"}</td>
                <td>${new Date(entry.addedAt).toLocaleString()}</td>
                <td>
                  <button type="button" class="ghost-button" data-entry="${entry.id}">詳細を見る</button>
                </td>
              `;
              datasetTableBody.appendChild(row);
              const actionButton = row.querySelector("button[data-entry]");
              actionButton?.addEventListener("click", () => {
                selectedDatasetEntryId = entry.id;
                renderDatasetDetails(entry, dataset);
              });
            });
          const current = dataset.entries.find((item) => item.id === selectedDatasetEntryId);
          renderDatasetDetails(current, dataset);
        }

        function renderDatasetSection() {
          if (!selectedDatasetAppId) {
            folderList.innerHTML = "";
            datasetTableBody.innerHTML = "";
            datasetFolderSelect.innerHTML = "";
            datasetEmpty.style.display = "block";
            renderDatasetDetails(null);
            if (learningSummaryList) learningSummaryList.innerHTML = "";
            return;
          }
          const dataset = ensureDataset(selectedDatasetAppId);
          if (selectedDatasetEntryId && !dataset.entries.find((entry) => entry.id === selectedDatasetEntryId)) {
            selectedDatasetEntryId = null;
          }
          renderFolders(dataset);
          renderDatasetTable(dataset);
          renderLearningSummary(dataset);
          const selectedApp = getAppById(selectedDatasetAppId);
          if (trainEmbedDatasetOutput && selectedApp) {
            trainEmbedDatasetOutput.value = buildTrainEmbedCode(selectedApp);
          }
        }

        ensureThemeOptions();
        if (appThemeSelect && !appThemeSelect.value) appThemeSelect.value = "ocean";
        if (fallbackInput && !fallbackInput.value) fallbackInput.value = DEFAULT_FALLBACK_MESSAGE;

        tabButtons.forEach((button) => {
          button.addEventListener("click", () => activateTab(button.dataset.tab));
        });
        activateTab(tabButtons.find((btn) => btn.classList.contains("active"))?.dataset.tab || "create");

        appBuilderForm?.addEventListener("submit", (event) => {
          event.preventDefault();
          const name = document.getElementById("app-name").value.trim();
          const purpose = document.getElementById("app-purpose").value.trim();
          const model = document.getElementById("app-model").value;
          const sources = document.getElementById("app-sources").value.trim();
          const theme = appThemeSelect?.value || "ocean";
          const fallbackMessage = fallbackInput?.value.trim() || DEFAULT_FALLBACK_MESSAGE;

          if (!name) {
            showMessage(createMessage, "アプリ名を入力してください。", "error");
            return;
          }

          const apps = getApps();
          const exists = apps.some((app) => app.name.toLowerCase() === name.toLowerCase());
          if (exists) {
            showMessage(createMessage, "同名のアプリが既に存在します。別の名前を指定してください。", "error");
            return;
          }

          const newApp = {
            id: crypto.randomUUID ? crypto.randomUUID() : `app-${Date.now()}`,
            name,
            purpose,
            model: model === "gpt-4o-mini" ? "GPT-4o mini" : model,
            sources: sources || "データソース未指定",
            theme,
            fallbackMessage,
            url: createAppUrl(name),
            trainUrl: createTrainUrl(name),
            createdAt: new Date().toISOString()
          };

          selectedDatasetAppId = newApp.id;
          apps.push(newApp);
          saveList(APP_STORAGE_KEY, apps);
          appBuilderForm.reset();
          showMessage(createMessage, `AIチャットベースのWebアプリを作成しました。URL: ${newApp.url}`, "success");
          renderApps();
        });

        suggestButton?.addEventListener("click", () => {
          document.getElementById("app-name").value = "Docs Q&A Copilot";
          document.getElementById("app-purpose").value = "社内ナレッジベースとGitHub READMEを検索して回答するチャットUIを生成";
          document.getElementById("app-model").value = "gpt-4o-mini";
          document.getElementById("app-sources").value = "Notion, GitHub repo, Slack export";
          if (appThemeSelect) appThemeSelect.value = "lavender";
          if (fallbackInput) fallbackInput.value = DEFAULT_FALLBACK_MESSAGE;
          showMessage(createMessage, "サンプルを読み込みました。このままCreateを押してください。", "success");
        });

        function handleRun(target) {
          const apps = getApps();
          const selectedId = appSelect.value || (apps[0]?.id ?? null);
          const selectedApp = apps.find((app) => app.id === selectedId);
          if (!selectedApp) {
            showMessage(runMessage, "先にアプリを作成してください。", "error");
            return;
          }

          showMessage(runMessage, `${selectedApp.name} を${target === "Deploy" ? "デプロイ" : "実行"}しています…`, "success");
          runButton?.setAttribute("disabled", "true");
          deployButton?.setAttribute("disabled", "true");

          setTimeout(() => {
            const runs = getRuns();
            const entry = {
              appId: selectedApp.id,
              appName: selectedApp.name,
              target: document.getElementById("deploy-target").value,
              timestamp: new Date().toISOString(),
              result: target === "Deploy" ? "デプロイ完了 (プレビューURLを発行しました)" : "成功"
            };
            runs.push(entry);
            saveList(RUN_STORAGE_KEY, runs);
            renderRuns();
            showMessage(runMessage, target === "Deploy" ? "デプロイが完了しました。プレビューURLを共有できます。" : "Runが完了しました。チャットUIが応答可能です。", "success");
            runButton?.removeAttribute("disabled");
            deployButton?.removeAttribute("disabled");
          }, 850);
        }

        runButton?.addEventListener("click", () => handleRun("Run"));
        deployButton?.addEventListener("click", () => handleRun("Deploy"));

        datasetBotSelect?.addEventListener("change", (event) => {
          selectedDatasetAppId = event.target.value;
          selectedDatasetEntryId = null;
          renderDatasetSection();
        });

        previewZoomInput?.addEventListener("input", () => {
          applyPreviewZoom(previewZoomInput.value);
        });

        previewBackgroundInput?.addEventListener("input", () => {
          applyPreviewBackground(previewBackgroundInput.value);
        });

        folderForm?.addEventListener("submit", (event) => {
          event.preventDefault();
          if (!selectedDatasetAppId) return;
          const name = folderNameInput.value.trim();
          if (!name) {
            showMessage(datasetMessage, "フォルダ名を入力してください。", "error");
            return;
          }
          const store = loadDatasetStore();
          const dataset = ensureDataset(selectedDatasetAppId);
          const duplicate = dataset.folders.find((folder) => folder.name.toLowerCase() === name.toLowerCase());
          if (duplicate) {
            showMessage(datasetMessage, "同名のフォルダが既に存在します。別の名前にしてください。", "error");
            return;
          }
          dataset.folders.push({ id: `folder-${Date.now()}`, name, createdAt: new Date().toISOString() });
          store[selectedDatasetAppId] = dataset;
          saveDatasetStore(store);
          folderNameInput.value = "";
          showMessage(datasetMessage, "フォルダを追加しました。", "success");
          renderDatasetSection();
        });

        datasetForm?.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (!selectedDatasetAppId) return;
          const title = datasetTitleInput.value.trim();
          const source = datasetSourceInput.value.trim();
          const folderId = datasetFolderSelect.value || "root";
          const fileType = datasetFileTypeSelect?.value || "other";
          const rawFiles = Array.from(datasetFilesInput?.files || []);
          const attachments = rawFiles.map((file) => ({
            name: file.name,
            size: file.size,
            type: file.type || fileType
          }));
          if (!title) {
            showMessage(datasetMessage, "データ名を入力してください。", "error");
            return;
          }
          const previewSource = rawFiles.find((file) => (file.type || fileType).startsWith("image/"));
          const previewDataUrl = await readImagePreview(previewSource);
          const store = loadDatasetStore();
          const dataset = ensureDataset(selectedDatasetAppId);
          const newEntryId = `entry-${Date.now()}`;
          dataset.entries.push({
            id: newEntryId,
            title,
            source,
            folderId,
            fileType,
            files: attachments,
            previewDataUrl,
            learningNotes: datasetLearningInput?.value.trim() || "",
            addedAt: new Date().toISOString()
          });
          store[selectedDatasetAppId] = dataset;
          saveDatasetStore(store);
          datasetTitleInput.value = "";
          datasetSourceInput.value = "";
          if (datasetLearningInput) datasetLearningInput.value = "";
          if (datasetFilesInput) datasetFilesInput.value = "";
          const attachmentNote = attachments.length ? ` (${attachments.length}ファイル添付)` : "";
          showMessage(datasetMessage, `学習データを保存しました${attachmentNote}。`, "success");
          selectedDatasetEntryId = newEntryId;
          renderDatasetSection();
        });

        shareBotSelect?.addEventListener("change", (event) => {
          selectedShareAppId = event.target.value;
          renderShareSection();
        });

        embedSizeRadios?.forEach((radio) => {
          radio.addEventListener("change", () => renderShareSection());
        });

        copyEmbedButton?.addEventListener("click", () => {
          if (!embedCodeOutput?.value) return;
          navigator.clipboard?.writeText(embedCodeOutput.value).then(() => {
            showMessage(shareMessage, "埋め込みコードをコピーしました。", "success");
          }).catch(() => {
            showMessage(shareMessage, "コピーに失敗しました。", "error");
          });
        });

        copyTrainShareButton?.addEventListener("click", () => {
          if (!trainEmbedShareOutput?.value) return;
          navigator.clipboard?.writeText(trainEmbedShareOutput.value).then(() => {
            showMessage(shareMessage, "TRAINページのコードをコピーしました。", "success");
          }).catch(() => {
            showMessage(shareMessage, "コピーに失敗しました。", "error");
          });
        });

        copyPreviewUrlButton?.addEventListener("click", () => {
          const app = getAppById(selectedShareAppId || shareBotSelect?.value);
          if (!app?.url) return;
          copyToClipboard(app.url, shareMessage, "プレビューURLをコピーしました。", "コピーに失敗しました。");
        });

        copyTrainUrlButton?.addEventListener("click", () => {
          const app = getAppById(selectedShareAppId || shareBotSelect?.value);
          if (!app?.trainUrl) return;
          copyToClipboard(app.trainUrl, shareMessage, "TRAINページURLをコピーしました。", "コピーに失敗しました。");
        });

        openBotWindowButton?.addEventListener("click", () => {
          const app = getAppById(selectedShareAppId || shareBotSelect?.value);
          if (!app) return;
          window.open(app.url, "_blank", "width=520,height=780");
        });

        openTrainWindowButton?.addEventListener("click", () => {
          const app = getAppById(selectedShareAppId || shareBotSelect?.value);
          if (!app) return;
          window.open(app.trainUrl, "_blank", "width=1200,height=780");
        });

        openPreviewUrlButton?.addEventListener("click", () => {
          const app = getAppById(selectedShareAppId || shareBotSelect?.value);
          if (!app?.url) return;
          window.open(app.url, "_blank", "width=520,height=780");
        });

        openTrainUrlButton?.addEventListener("click", () => {
          const app = getAppById(selectedShareAppId || shareBotSelect?.value);
          if (!app?.trainUrl) return;
          window.open(app.trainUrl, "_blank", "width=1200,height=780");
        });

        saveSelectedThemeButton?.addEventListener("click", () => {
          const app = getAppById(selectedShareAppId || shareBotSelect?.value);
          const themeKey = selectedThemeSelect?.value || "ocean";
          if (!app) {
            showMessage(shareMessage, "先にボットを選択してください。", "error");
            return;
          }
          if (!THEME_LIBRARY[themeKey]) {
            showMessage(shareMessage, "テーマを選択してください。", "error");
            return;
          }
          const updated = updateAppTheme(app.id, themeKey);
          if (!updated) {
            showMessage(shareMessage, "テーマの更新に失敗しました。", "error");
            return;
          }
          showMessage(shareMessage, `テーマを ${getTheme(themeKey).label} に更新しました。`, "success");
          renderApps();
        });

        copyTrainEmbedButton?.addEventListener("click", () => {
          if (!trainEmbedDatasetOutput?.value) return;
          navigator.clipboard?.writeText(trainEmbedDatasetOutput.value).then(() => {
            showMessage(datasetMessage, "TRAIN埋め込みコードをコピーしました。", "success");
          }).catch(() => {
            showMessage(datasetMessage, "コピーに失敗しました。", "error");
          });
        });

        signOutButton?.addEventListener("click", () => {
          sessionStorage.removeItem(SESSION_KEY);
          sessionStorage.removeItem("platformAdminSession");
          localStorage.removeItem(REMEMBER_KEY);
          localStorage.removeItem(ADMIN_REMEMBER_KEY);
          window.location.href = "./login.html";
        });

        renderApps();
        renderRuns();
        renderSession();
      })();
    </script>
  </body>
</html>
